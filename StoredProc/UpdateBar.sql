exec sp_executesql N'--INSERT INTO #tt415 WITH(TABLOCK) (_Q_000_F_000_TYPE, _Q_000_F_000_RTRef, _Q_000_F_000_RRRef, _Q_000_F_001, _Q_000_F_002, _Q_000_F_003) 
SELECT
T1._Fld3299_TYPE _Q_000_F_000_TYPE,
T1._Fld3299_RTRef _Q_000_F_000_RTRef,
T1._Fld3299_RRRef _Q_000_F_000_RRRef,
CAST(CAST(SUM(T1._Fld3302) AS NUMERIC(21, 3)) AS NUMERIC(22, 3)) _Q_000_F_001,
CASE WHEN (T1._Fld3302 < 0.0) THEN 0x01 ELSE 0x00 END _Q_000_F_002,
@P1 _Q_000_F_003
into ##tt415
FROM dbo._AccumRg3296 T1
WHERE ((T1._Fld4704 = @P2)) AND ((T1._Period >= @P3) AND (T1._Period <= @P4) AND (T1._RecordKind = @P5) AND (T1._Fld3299_TYPE = 0x08 AND T1._Fld3299_RTRef = 0x00000075))
GROUP BY T1._Fld3299_TYPE,
T1._Fld3299_RTRef,
T1._Fld3299_RRRef,
CASE WHEN (T1._Fld3302 < 0.0) THEN 0x01 ELSE 0x00 END
HAVING (CAST(SUM(T1._Fld3302) AS NUMERIC(21, 3)) <> 0.0)
UNION ALL SELECT
T3._Fld1936_TYPE,
T3._Fld1936_RTRef,
T3._Fld1936_RRRef,
(-1.0 * CAST(SUM(T2._Fld3302) AS NUMERIC(21, 3))),
0x00,
@P6
FROM dbo._AccumRg3296 T2
INNER JOIN dbo._Document115_VT1934X1 T3
ON (T2._RecorderTRef = 0x00000073 AND T2._RecorderRRef = T3._Document115_IDRRef)
WHERE (((T2._Fld4704 = @P7)) AND (T3._Fld4704 = @P8)) AND ((T2._Period >= @P9) AND (T2._Period <= @P10) AND (T2._Fld3302 > @P11) AND (T2._RecordKind = @P12) AND (T2._Fld3300RRef = @P13) AND (T3._Fld1936_TYPE = 0x08 AND T3._Fld1936_RTRef = 0x00000075))
GROUP BY T3._Fld1936_TYPE,
T3._Fld1936_RTRef,
T3._Fld1936_RRRef
UNION ALL SELECT
T7._Fld1936_TYPE,
T7._Fld1936_RTRef,
T7._Fld1936_RRRef,
(-1.0 * CAST(SUM(T4._Fld3302) AS NUMERIC(21, 3))),
0x00,
@P14
FROM dbo._AccumRg3296 T4
INNER JOIN dbo._Document115_VT1934X1 T5
LEFT OUTER JOIN dbo._Document115X1 T6
ON (T5._Document115_IDRRef = T6._IDRRef) AND (T6._Fld4704 = @P15)
LEFT OUTER JOIN dbo._Document115_VT1934X1 T7
LEFT OUTER JOIN dbo._Document117 T8
ON (T7._Fld1936_TYPE = 0x08 AND T7._Fld1936_RTRef = 0x00000075 AND T7._Fld1936_RRRef = T8._IDRRef) AND (T8._Fld4704 = @P16)
LEFT OUTER JOIN dbo._Document100 T9
ON (T7._Fld1936_TYPE = 0x08 AND T7._Fld1936_RTRef = 0x00000064 AND T7._Fld1936_RRRef = T9._IDRRef) AND (T9._Fld4704 = @P17)
LEFT OUTER JOIN dbo._Document115X1 T10
ON (T7._Fld1936_TYPE = 0x08 AND T7._Fld1936_RTRef = 0x00000073 AND T7._Fld1936_RRRef = T10._IDRRef) AND (T10._Fld4704 = @P18)
LEFT OUTER JOIN dbo._Document99 T11
ON (T7._Fld1936_TYPE = 0x08 AND T7._Fld1936_RTRef = 0x00000063 AND T7._Fld1936_RRRef = T11._IDRRef) AND (T11._Fld4704 = @P19)
LEFT OUTER JOIN dbo._Document120 T12
ON (T7._Fld1936_TYPE = 0x08 AND T7._Fld1936_RTRef = 0x00000078 AND T7._Fld1936_RRRef = T12._IDRRef) AND (T12._Fld4704 = @P20)
ON ((T5._Fld1936_TYPE = 0x08 AND T5._Fld1936_RTRef = 0x00000073 AND T5._Fld1936_RRRef = T7._Document115_IDRRef) AND (T6._Fld1910_TYPE = CASE WHEN T7._Fld1936_TYPE = 0x08 AND T7._Fld1936_RTRef = 0x00000075 THEN CASE WHEN T8._Fld1969RRef IS NOT NULL THEN 0x08 END WHEN T7._Fld1936_TYPE = 0x08 AND T7._Fld1936_RTRef = 0x00000064 THEN CASE WHEN T9._Fld1551RRef IS NOT NULL THEN 0x08 END WHEN T7._Fld1936_TYPE = 0x08 AND T7._Fld1936_RTRef = 0x00000073 THEN T10._Fld1910_TYPE WHEN T7._Fld1936_TYPE = 0x08 AND T7._Fld1936_RTRef = 0x00000063 THEN CASE WHEN T11._Fld1511RRef IS NOT NULL THEN 0x08 END WHEN T7._Fld1936_TYPE = 0x08 AND T7._Fld1936_RTRef = 0x00000078 THEN T12._Fld2077_TYPE ELSE CAST(NULL AS BINARY(1)) END AND T6._Fld1910_RTRef = CASE WHEN T7._Fld1936_TYPE = 0x08 AND T7._Fld1936_RTRef = 0x00000075 THEN CASE WHEN T8._Fld1969RRef IS NOT NULL THEN 0x00000033 END WHEN T7._Fld1936_TYPE = 0x08 AND T7._Fld1936_RTRef = 0x00000064 THEN CASE WHEN T9._Fld1551RRef IS NOT NULL THEN 0x00000033 END WHEN T7._Fld1936_TYPE = 0x08 AND T7._Fld1936_RTRef = 0x00000073 THEN T10._Fld1910_RTRef WHEN T7._Fld1936_TYPE = 0x08 AND T7._Fld1936_RTRef = 0x00000063 THEN CASE WHEN T11._Fld1511RRef IS NOT NULL THEN 0x00000033 END WHEN T7._Fld1936_TYPE = 0x08 AND T7._Fld1936_RTRef = 0x00000078 THEN T12._Fld2077_RTRef ELSE CAST(NULL AS BINARY(4)) END AND T6._Fld1910_RRRef = CASE WHEN T7._Fld1936_TYPE = 0x08 AND T7._Fld1936_RTRef = 0x00000075 THEN T8._Fld1969RRef WHEN T7._Fld1936_TYPE = 0x08 AND T7._Fld1936_RTRef = 0x00000064 THEN T9._Fld1551RRef WHEN T7._Fld1936_TYPE = 0x08 AND T7._Fld1936_RTRef = 0x00000073 THEN T10._Fld1910_RRRef WHEN T7._Fld1936_TYPE = 0x08 AND T7._Fld1936_RTRef = 0x00000063 THEN T11._Fld1511RRef WHEN T7._Fld1936_TYPE = 0x08 AND T7._Fld1936_RTRef = 0x00000078 THEN T12._Fld2077_RRRef ELSE CAST(NULL AS BINARY(16)) END)) AND (T7._Fld4704 = @P21)
ON (T4._RecorderTRef = 0x00000073 AND T4._RecorderRRef = T5._Document115_IDRRef)
WHERE (((T4._Fld4704 = @P22)) AND (T5._Fld4704 = @P23)) AND ((T4._Period >= @P24) AND (T4._Period <= @P25) AND (T4._Fld3302 > @P26) AND (T4._RecordKind = @P27) AND (T4._Fld3300RRef = @P28) AND (T7._Fld1936_TYPE = 0x08 AND T7._Fld1936_RTRef = 0x00000075))
GROUP BY T7._Fld1936_TYPE,
T7._Fld1936_RTRef,
T7._Fld1936_RRRef',N'@P1 nvarchar(4000),@P2 numeric(10),@P3 datetime2(3),@P4 datetime2(3),@P5 numeric(10),@P6 nvarchar(4000),@P7 numeric(10),@P8 numeric(10),@P9 datetime2(3),@P10 datetime2(3),@P11 numeric(10),@P12 numeric(10),@P13 varbinary(16),@P14 nvarchar(4000),@P15 numeric(10),@P16 numeric(10),@P17 numeric(10),@P18 numeric(10),@P19 numeric(10),@P20 numeric(10),@P21 numeric(10),@P22 numeric(10),@P23 numeric(10),@P24 datetime2(3),@P25 datetime2(3),@P26 numeric(10),@P27 numeric(10),@P28 varbinary(16)',N'denso',0,'4022-10-01 00:00:00','4022-10-31 23:59:59',0,N'denso',0,0,'4022-10-01 00:00:00','4022-10-31 23:59:59',0,0,0xBC4D6045501420854473166B955392A3,N'denso',0,0,0,0,0,0,0,0,0,'4022-10-01 00:00:00','4022-10-31 23:59:59',0,0,0xBC4D6045501420854473166B955392A3


exec sp_executesql N'--INSERT INTO #tt416 WITH(TABLOCK) (_Q_000_F_000_TYPE, _Q_000_F_000_RTRef, _Q_000_F_000_RRRef, _Q_000_F_001, _Q_000_F_002, _Q_000_F_003) 
SELECT
T1._Q_000_F_000_TYPE _Q_000_F_000_TYPE,
T1._Q_000_F_000_RTRef _Q_000_F_000_RTRef,
T1._Q_000_F_000_RRRef _Q_000_F_000_RRRef,
CAST(SUM(T1._Q_000_F_001) AS NUMERIC(28, 3)) _Q_000_F_001,
T1._Q_000_F_002 _Q_000_F_002,
@P1 _Q_000_F_003
into ##tt416
FROM ##tt415 T1 WITH(NOLOCK)
GROUP BY T1._Q_000_F_000_TYPE,
T1._Q_000_F_000_RTRef,
T1._Q_000_F_000_RRRef,
T1._Q_000_F_002',N'@P1 nvarchar(4000)',N'denso'


exec sp_executesql N'--INSERT INTO #tt417 WITH(TABLOCK) (_Q_000_F_000, _Q_000_F_001TRef, _Q_000_F_001RRef, _Q_000_F_002) 
SELECT
CAST(SUM(T1._Fld3232) AS NUMERIC(21, 2)) _Q_000_F_000, 
T1._RecorderTRef _Q_000_F_001TRef, 
T1._RecorderRRef _Q_000_F_001RRef,
@P1 _Q_000_F_002
into ##tt417
FROM dbo._AccumRg3221 T1
WHERE (T1._Fld4704 = @P2)
GROUP BY T1._RecorderTRef,
T1._RecorderRRef',N'@P1 nvarchar(4000),@P2 numeric(10)',N'denso',0




exec sp_executesql N'--INSERT INTO #tt418 WITH(TABLOCK) (_Q_000_F_000RRef, _Q_000_F_001RRef, _Q_000_F_002RRef, _Q_000_F_003_TYPE, 
--_Q_000_F_003_RTRef, _Q_000_F_003_RRRef, _Q_000_F_004RRef, _Q_000_F_005, _Q_000_F_006, _Q_000_F_007) 
SELECT
T2._Fld3222RRef _Q_000_F_000RRef,
T2._Fld3226RRef _Q_000_F_001RRef,
T2._Fld3224RRef _Q_000_F_002RRef,
T2._Fld3223_TYPE _Q_000_F_003_TYPE,
T2._Fld3223_RTRef _Q_000_F_003_RTRef,
T2._Fld3223_RRRef _Q_000_F_003_RRRef,
T2._Fld3225RRef _Q_000_F_004RRef,
((CAST(CAST(SUM(T2._Fld3232) AS NUMERIC(21, 2)) AS NUMERIC(15, 2)) * CAST(CAST(SUM(T1._Q_000_F_001) AS NUMERIC(34, 3)) AS NUMERIC(22, 3))) / CAST(SUM(T3._Q_000_F_000) AS NUMERIC(27, 2))) _Q_000_F_005,
CAST(SUM(T2._Fld3231) AS NUMERIC(21, 3)) _Q_000_F_006,
@P1 _Q_000_F_007,
T2._Period
into ##Barsales
FROM ##tt416 T1 WITH(NOLOCK)
INNER JOIN dbo._AccumRg3221 T2
ON (T1._Q_000_F_000_TYPE = 0x08 AND T1._Q_000_F_000_RTRef = T2._RecorderTRef AND T1._Q_000_F_000_RRRef = T2._RecorderRRef)
INNER JOIN ##tt417 T3 WITH(NOLOCK)
ON (T2._RecorderTRef = T3._Q_000_F_001TRef AND T2._RecorderRRef = T3._Q_000_F_001RRef)
INNER JOIN dbo._InfoRg2977 T4
LEFT OUTER JOIN dbo._Reference69 T5
ON (T4._Fld2978_TYPE = 0x08 AND T4._Fld2978_RTRef = 0x00000045 AND T4._Fld2978_RRRef = T5._IDRRef) AND (T5._Fld4704 = @P2)
LEFT OUTER JOIN dbo._Reference68 T6
ON (T4._Fld2978_TYPE = 0x08 AND T4._Fld2978_RTRef = 0x00000044 AND T4._Fld2978_RRRef = T6._IDRRef) AND (T6._Fld4704 = @P3)
LEFT OUTER JOIN dbo._Reference67 T7
ON (T4._Fld2978_TYPE = 0x08 AND T4._Fld2978_RTRef = 0x00000043 AND T4._Fld2978_RRRef = T7._IDRRef) AND (T7._Fld4704 = @P4)
ON (0x08 = T4._Fld2979_TYPE AND 0x00000038 = T4._Fld2979_RTRef AND T2._Fld3226RRef = T4._Fld2979_RRRef) AND (CASE WHEN T4._Fld2978_TYPE = 0x08 AND T4._Fld2978_RTRef = 0x00000045 THEN T5._Description WHEN T4._Fld2978_TYPE = 0x08 AND T4._Fld2978_RTRef = 0x00000044 THEN T6._Description WHEN T4._Fld2978_TYPE = 0x08 AND T4._Fld2978_RTRef = 0x00000043 THEN T7._Description ELSE CAST(NULL AS NVARCHAR(100)) END = @P5)
WHERE ((T2._Fld4704 = @P6)) AND (T4._Fld4704 = @P7)
GROUP BY T2._Fld3226RRef,
T2._Fld3224RRef,
T2._Fld3223_TYPE,
T2._Fld3223_RTRef,
T2._Fld3223_RRRef,
T2._Fld3225RRef,
T2._Fld3222RRef,
T2._Period
HAVING (CAST(SUM(T3._Q_000_F_000) AS NUMERIC(27, 2)) <> 0.0)',N'@P1 nvarchar(4000),@P2 numeric(10),@P3 numeric(10),@P4 numeric(10),@P5 nvarchar(4000),@P6 numeric(10),@P7 numeric(10)',N'denso',0,0,0,N'Бар сумма (ТФ)',0,0


delete
from    dwh.[dbo].[BarSales]


INSERT INTO dwh.[dbo].[BarSales]
           ([Date]
           ,[ClubID]
           ,[ItemID]
           ,[ClientID]
           ,[SaleID]
           ,[ManagerID]
           ,[Amount]
           ,[Qty])
select  dateadd(year,-2000,_Period),
        sys.fn_varbintohexstr(_Q_000_F_000RRef),
        sys.fn_varbintohexstr(_Q_000_F_001RRef),
        sys.fn_varbintohexstr(_Q_000_F_002RRef),
        sys.fn_varbintohexstr(_Q_000_F_003_RRRef),
        sys.fn_varbintohexstr(_Q_000_F_004RRef),
        _Q_000_F_005,
        _Q_000_F_006
from    ##Barsales





drop table ##tt415
drop table ##tt416
drop table ##tt417
drop table ##Barsales