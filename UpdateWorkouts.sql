SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
ALTER PROCEDURE [dbo].[UpdateWorkouts]
	@DateStart datetime2(3),
	@DateEnd datetime2(3)
AS
BEGIN

select	@DateStart = dateadd(year,2000,@DateStart),
		@DateEnd = dateadd(year,2000,@DateEnd)



--Занятия по сегментам
exec sp_executesql --N'INSERT INTO ##DWH_tt292 WITH(TABLOCK) (_Q_000_F_000_TYPE, _Q_000_F_000_RTRef, _Q_000_F_000_RRRef, _Q_000_F_001, _Q_000_F_002RRef, _Q_000_F_003RRef, _Q_000_F_004RRef, _Q_000_F_005RRef, _Q_000_F_006) 
N'SELECT
T4._Fld2978_TYPE _Q_000_F_000_TYPE,
T4._Fld2978_RTRef _Q_000_F_000_RTRef,
T4._Fld2978_RRRef _Q_000_F_000_RRRef,
CAST(SUM(T1.Fld3171Turnover_) AS NUMERIC(38, 8)) _Q_000_F_001,
T1.Fld3162RRef _Q_000_F_002RRef,
T1.Fld3164RRef _Q_000_F_003RRef,
T1.Fld3166RRef _Q_000_F_004RRef,
T1.Fld3167RRef _Q_000_F_005RRef,
@P1 _Q_000_F_006,
ISNULL(T11._Date_Time,CASE WHEN T1.Fld3170_TYPE = 0x08 AND T1.Fld3170_RTRef = 0x00000075 THEN T12._Date_Time WHEN T1.Fld3170_TYPE = 0x08 AND T1.Fld3170_RTRef = 0x00000062 THEN T13._Date_Time ELSE CAST(NULL AS DATETIME) END) _Q_000_F_007
into ##DWH_tt292
FROM (SELECT
T2._Fld3166RRef AS Fld3166RRef,
T2._Fld3162RRef AS Fld3162RRef,
T2._Fld3164RRef AS Fld3164RRef,
T2._Fld3167RRef AS Fld3167RRef,
T2._Fld3170_TYPE AS Fld3170_TYPE,
T2._Fld3170_RTRef AS Fld3170_RTRef,
T2._Fld3170_RRRef AS Fld3170_RRRef,
T2._Fld3169_TYPE AS Fld3169_TYPE,
T2._Fld3169_RTRef AS Fld3169_RTRef,
T2._Fld3169_RRRef AS Fld3169_RRRef,
CAST(SUM(T2._Fld3171) AS NUMERIC(21, 3)) AS Fld3171Turnover_,
CAST(SUM(T2._Fld3172) AS NUMERIC(21, 2)) AS Fld3172Turnover_
FROM dbo._AccumRg3161 T2
LEFT OUTER JOIN dbo._Reference56X1 T3
ON (T2._Fld3166RRef = T3._IDRRef) AND (T3._Fld4704 = @P2)
WHERE ((T2._Fld4704 = @P3)) AND (T2._Period >= @P4 AND T2._Period <= @P5 AND T2._Active = 0x01 AND ((NOT (((T2._Fld3163RRef = 0x00000000000000000000000000000000)))) AND (T3._Fld6360 = 0x00)))
GROUP BY T2._Fld3166RRef,
T2._Fld3162RRef,
T2._Fld3164RRef,
T2._Fld3167RRef,
T2._Fld3170_TYPE,
T2._Fld3170_RTRef,
T2._Fld3170_RRRef,
T2._Fld3169_TYPE,
T2._Fld3169_RTRef,
T2._Fld3169_RRRef
HAVING (CAST(SUM(T2._Fld3171) AS NUMERIC(21, 3))) <> 0.0 OR (CAST(SUM(T2._Fld3172) AS NUMERIC(21, 2))) <> 0.0) T1
INNER JOIN dbo._InfoRg2977 T4
LEFT OUTER JOIN dbo._Reference69 T5
ON (T4._Fld2978_TYPE = 0x08 AND T4._Fld2978_RTRef = 0x00000045 AND T4._Fld2978_RRRef = T5._IDRRef) AND (T5._Fld4704 = @P6)
LEFT OUTER JOIN dbo._Reference69 T6
ON (T5._ParentIDRRef = T6._IDRRef) AND (T6._Fld4704 = @P7)
LEFT OUTER JOIN dbo._Reference68 T7
ON (T4._Fld2978_TYPE = 0x08 AND T4._Fld2978_RTRef = 0x00000044 AND T4._Fld2978_RRRef = T7._IDRRef) AND (T7._Fld4704 = @P8)
LEFT OUTER JOIN dbo._Reference68 T8
ON (T7._ParentIDRRef = T8._IDRRef) AND (T8._Fld4704 = @P9)
LEFT OUTER JOIN dbo._Reference67 T9
ON (T4._Fld2978_TYPE = 0x08 AND T4._Fld2978_RTRef = 0x00000043 AND T4._Fld2978_RRRef = T9._IDRRef) AND (T9._Fld4704 = @P10)
LEFT OUTER JOIN dbo._Reference67 T10
ON (T9._ParentIDRRef = T10._IDRRef) AND (T10._Fld4704 = @P11)
ON (0x08 = T4._Fld2979_TYPE AND 0x00000038 = T4._Fld2979_RTRef AND T1.Fld3166RRef = T4._Fld2979_RRRef) AND (CASE WHEN T4._Fld2978_TYPE = 0x08 AND T4._Fld2978_RTRef = 0x00000045 THEN T6._Description WHEN T4._Fld2978_TYPE = 0x08 AND T4._Fld2978_RTRef = 0x00000044 THEN T8._Description WHEN T4._Fld2978_TYPE = 0x08 AND T4._Fld2978_RTRef = 0x00000043 THEN T10._Description ELSE CAST(NULL AS NVARCHAR(100)) END = @P12)
LEFT OUTER JOIN dbo._Document105X1 T11
ON (T1.Fld3164RRef = T11._IDRRef) AND (T11._Fld4704 = @P13)
LEFT OUTER JOIN dbo._Document117 T12
ON (T1.Fld3170_TYPE = 0x08 AND T1.Fld3170_RTRef = 0x00000075 AND T1.Fld3170_RRRef = T12._IDRRef) AND (T12._Fld4704 = @P14)
LEFT OUTER JOIN dbo._Document98 T13
ON (T1.Fld3170_TYPE = 0x08 AND T1.Fld3170_RTRef = 0x00000062 AND T1.Fld3170_RRRef = T13._IDRRef) AND (T13._Fld4704 = @P15)
WHERE ((T4._Fld4704 = @P16)) AND ((T1.Fld3172Turnover_ > @P17))
GROUP BY T4._Fld2978_TYPE,
T4._Fld2978_RTRef,
T4._Fld2978_RRRef,
T1.Fld3162RRef,
T1.Fld3164RRef,
T1.Fld3166RRef,
T1.Fld3167RRef,
T1.Fld3170_TYPE,
T1.Fld3170_RTRef,
T1.Fld3170_RRRef,
T1.Fld3169_TYPE,
T1.Fld3169_RTRef,
T1.Fld3169_RRRef,
ISNULL(T11._Date_Time,CASE WHEN T1.Fld3170_TYPE = 0x08 AND T1.Fld3170_RTRef = 0x00000075 THEN T12._Date_Time WHEN T1.Fld3170_TYPE = 0x08 AND T1.Fld3170_RTRef = 0x00000062 THEN T13._Date_Time ELSE CAST(NULL AS DATETIME) END)',N'@P1 nvarchar(4000),@P2 numeric(10),@P3 numeric(10),@P4 datetime2(3),@P5 datetime2(3),@P6 numeric(10),@P7 numeric(10),@P8 numeric(10),@P9 numeric(10),@P10 numeric(10),@P11 numeric(10),@P12 nvarchar(4000),@P13 numeric(10),@P14 numeric(10),@P15 numeric(10),@P16 numeric(10),@P17 numeric(10)',N'denso',0,0,@DateStart,@DateEnd,0,0,0,0,0,0,N'Отчет продажи фитнес',0,0,0,0,0



--Итог
exec sp_executesql N'SELECT 
T1._Q_000_F_000_TYPE,
T1._Q_000_F_000_RTRef,
T1._Q_000_F_000_RRRef segmentID,
CAST(SUM(T1._Q_000_F_001) AS NUMERIC(33, 3)) Visitors,
T1._Q_000_F_002RRef ClubID,
count (distinct CASE WHEN (T1._Q_000_F_003RRef = 0x00000000000000000000000000000000) THEN CAST(NULL AS BINARY(16)) ELSE T1._Q_000_F_003RRef END) WorkoutID,
T1._Q_000_F_004RRef ServiceID,
T1._Q_000_F_005RRef ManagerID,
@P1 test,
DATEADD(DAY,CAST(DATEPART(DAY,T1._Q_000_F_007) AS NUMERIC(4)) - 1,DATEADD(MONTH,CAST(DATEPART(MONTH,T1._Q_000_F_007) AS NUMERIC(4)) - 1,DATEADD(YEAR,(CAST(DATEPART(YEAR,T1._Q_000_F_007) AS NUMERIC(4)) - 2000) - 2000,{ts ''4000-01-01 00:00:00''}))) [Date],
SUBSTRING(CASE WHEN T1._Q_000_F_000_TYPE = 0x08 AND T1._Q_000_F_000_RTRef = 0x00000045 THEN T2._Fld1027 WHEN T1._Q_000_F_000_TYPE = 0x08 AND T1._Q_000_F_000_RTRef = 0x00000044 THEN T3._Fld1019 WHEN T1._Q_000_F_000_TYPE = 0x08 AND T1._Q_000_F_000_RTRef = 0x00000043 THEN T4._Fld1011 ELSE CAST(NULL AS NVARCHAR(MAX)) END, CAST(1.0 AS INT), CAST(50.0 AS INT)) ServiceType,
CASE WHEN (CAST(CHARINDEX(N''Бассейн'',CASE WHEN T1._Q_000_F_000_TYPE = 0x08 AND T1._Q_000_F_000_RTRef = 0x00000045 THEN T2._Fld1027 WHEN T1._Q_000_F_000_TYPE = 0x08 AND T1._Q_000_F_000_RTRef = 0x00000044 THEN T3._Fld1019 
WHEN T1._Q_000_F_000_TYPE = 0x08 AND T1._Q_000_F_000_RTRef = 0x00000043 THEN T4._Fld1011 ELSE CAST(NULL AS NVARCHAR(MAX)) END) AS NUMERIC(12, 0)) > 0.0) THEN N''Бассейн'' WHEN (CAST(CHARINDEX(N''Групповые'',CASE WHEN 
T1._Q_000_F_000_TYPE = 0x08 AND T1._Q_000_F_000_RTRef = 0x00000045 THEN T2._Fld1027 WHEN T1._Q_000_F_000_TYPE = 0x08 AND T1._Q_000_F_000_RTRef = 0x00000044 THEN T3._Fld1019 WHEN T1._Q_000_F_000_TYPE = 0x08 AND 
T1._Q_000_F_000_RTRef = 0x00000043 THEN T4._Fld1011 ELSE CAST(NULL AS NVARCHAR(MAX)) END) AS NUMERIC(12, 0)) > 0.0) THEN N''Групповые'' WHEN (CAST(CHARINDEX(N''Детский клуб'',CASE WHEN T1._Q_000_F_000_TYPE = 0x08 AND 
T1._Q_000_F_000_RTRef = 0x00000045 THEN T2._Fld1027 WHEN T1._Q_000_F_000_TYPE = 0x08 AND T1._Q_000_F_000_RTRef = 0x00000044 THEN T3._Fld1019 WHEN T1._Q_000_F_000_TYPE = 0x08 AND T1._Q_000_F_000_RTRef = 0x00000043 THEN 
T4._Fld1011 ELSE CAST(NULL AS NVARCHAR(MAX)) END) AS NUMERIC(12, 0)) > 0.0) THEN N''Детский клуб'' WHEN (CAST(CHARINDEX(N''Единоборства'',CASE WHEN T1._Q_000_F_000_TYPE = 0x08 AND T1._Q_000_F_000_RTRef = 0x00000045 THEN 
T2._Fld1027 WHEN T1._Q_000_F_000_TYPE = 0x08 AND T1._Q_000_F_000_RTRef = 0x00000044 THEN T3._Fld1019 WHEN T1._Q_000_F_000_TYPE = 0x08 AND T1._Q_000_F_000_RTRef = 0x00000043 THEN T4._Fld1011 ELSE CAST(NULL AS NVARCHAR(MAX)) END) AS NUMERIC(12, 0)) > 0.0) THEN N''Единоборства'' WHEN (CAST(CHARINDEX(N''Игровые виды'',CASE WHEN T1._Q_000_F_000_TYPE = 0x08 AND T1._Q_000_F_000_RTRef = 0x00000045 THEN T2._Fld1027 WHEN T1._Q_000_F_000_TYPE = 0x08 AND T1._Q_000_F_000_RTRef = 0x00000044 THEN T3._Fld1019 WHEN T1._Q_000_F_000_TYPE = 0x08 AND T1._Q_000_F_000_RTRef = 0x00000043 THEN T4._Fld1011 ELSE CAST(NULL AS NVARCHAR(MAX)) END) AS NUMERIC(12, 0)) > 0.0) THEN N''Игровые виды'' WHEN (CAST(CHARINDEX(N''Массаж'',CASE WHEN T1._Q_000_F_000_TYPE = 0x08 AND T1._Q_000_F_000_RTRef = 0x00000045 THEN T2._Fld1027 WHEN T1._Q_000_F_000_TYPE = 0x08 AND T1._Q_000_F_000_RTRef = 0x00000044 THEN T3._Fld1019 WHEN T1._Q_000_F_000_TYPE = 0x08 AND T1._Q_000_F_000_RTRef = 0x00000043 THEN T4._Fld1011 ELSE CAST(NULL AS NVARCHAR(MAX)) END) AS NUMERIC(12, 0)) > 0.0) THEN N''Массаж'' WHEN (CAST(CHARINDEX(N''Тренажерный зал'',CASE WHEN T1._Q_000_F_000_TYPE = 0x08 AND T1._Q_000_F_000_RTRef = 0x00000045 THEN T2._Fld1027 WHEN T1._Q_000_F_000_TYPE = 0x08 AND T1._Q_000_F_000_RTRef = 0x00000044 THEN T3._Fld1019 WHEN T1._Q_000_F_000_TYPE = 0x08 AND T1._Q_000_F_000_RTRef = 0x00000043 THEN T4._Fld1011 ELSE CAST(NULL AS NVARCHAR(MAX)) END) AS NUMERIC(12, 0)) > 0.0) THEN N''Тренажерный зал'' WHEN (CAST(CHARINDEX(N''Мед. услуги'',CASE WHEN T1._Q_000_F_000_TYPE = 0x08 AND T1._Q_000_F_000_RTRef = 0x00000045 THEN T2._Fld1027 WHEN T1._Q_000_F_000_TYPE = 0x08 AND T1._Q_000_F_000_RTRef = 0x00000044 THEN T3._Fld1019 WHEN T1._Q_000_F_000_TYPE = 0x08 AND T1._Q_000_F_000_RTRef = 0x00000043 THEN T4._Fld1011 ELSE CAST(NULL AS NVARCHAR(MAX)) END) AS NUMERIC(12, 0)) > 0.0) THEN N''Мед. услуги'' ELSE N''Другое'' END Department
into ##DWH_Workouts1
FROM ##DWH_tt292 T1 WITH(NOLOCK)
LEFT OUTER JOIN dbo._Reference69 T2
ON (T1._Q_000_F_000_TYPE = 0x08 AND T1._Q_000_F_000_RTRef = 0x00000045 AND T1._Q_000_F_000_RRRef = T2._IDRRef) AND (T2._Fld4704 = @P2)
LEFT OUTER JOIN dbo._Reference68 T3
ON (T1._Q_000_F_000_TYPE = 0x08 AND T1._Q_000_F_000_RTRef = 0x00000044 AND T1._Q_000_F_000_RRRef = T3._IDRRef) AND (T3._Fld4704 = @P3)
LEFT OUTER JOIN dbo._Reference67 T4
ON (T1._Q_000_F_000_TYPE = 0x08 AND T1._Q_000_F_000_RTRef = 0x00000043 AND T1._Q_000_F_000_RRRef = T4._IDRRef) AND (T4._Fld4704 = @P4)
GROUP BY T1._Q_000_F_000_TYPE,
T1._Q_000_F_000_RTRef,
T1._Q_000_F_000_RRRef,
T1._Q_000_F_002RRef,
T1._Q_000_F_004RRef,
T1._Q_000_F_005RRef,
DATEADD(DAY,CAST(DATEPART(DAY,T1._Q_000_F_007) AS NUMERIC(4)) - 1,DATEADD(MONTH,CAST(DATEPART(MONTH,T1._Q_000_F_007) AS NUMERIC(4)) - 1,DATEADD(YEAR,(CAST(DATEPART(YEAR,T1._Q_000_F_007) AS NUMERIC(4)) - 2000) - 2000,{ts ''4000-01-01 00:00:00''}))),
SUBSTRING(CASE WHEN T1._Q_000_F_000_TYPE = 0x08 AND T1._Q_000_F_000_RTRef = 0x00000045 THEN T2._Fld1027 WHEN T1._Q_000_F_000_TYPE = 0x08 AND T1._Q_000_F_000_RTRef = 0x00000044 THEN T3._Fld1019 WHEN T1._Q_000_F_000_TYPE = 0x08 AND T1._Q_000_F_000_RTRef = 0x00000043 THEN T4._Fld1011 ELSE CAST(NULL AS NVARCHAR(MAX)) END, CAST(1.0 AS INT), CAST(50.0 AS INT)),
CASE WHEN (CAST(CHARINDEX(N''Бассейн'',CASE WHEN T1._Q_000_F_000_TYPE = 0x08 AND T1._Q_000_F_000_RTRef = 0x00000045 THEN T2._Fld1027 WHEN T1._Q_000_F_000_TYPE = 0x08 AND T1._Q_000_F_000_RTRef = 0x00000044 THEN T3._Fld1019 
WHEN T1._Q_000_F_000_TYPE = 0x08 AND T1._Q_000_F_000_RTRef = 0x00000043 THEN T4._Fld1011 ELSE CAST(NULL AS NVARCHAR(MAX)) END) AS NUMERIC(12, 0)) > 0.0) THEN N''Бассейн'' WHEN (CAST(CHARINDEX(N''Групповые'',CASE WHEN 
T1._Q_000_F_000_TYPE = 0x08 AND T1._Q_000_F_000_RTRef = 0x00000045 THEN T2._Fld1027 WHEN T1._Q_000_F_000_TYPE = 0x08 AND T1._Q_000_F_000_RTRef = 0x00000044 THEN T3._Fld1019 WHEN T1._Q_000_F_000_TYPE = 0x08 AND 
T1._Q_000_F_000_RTRef = 0x00000043 THEN T4._Fld1011 ELSE CAST(NULL AS NVARCHAR(MAX)) END) AS NUMERIC(12, 0)) > 0.0) THEN N''Групповые'' WHEN (CAST(CHARINDEX(N''Детский клуб'',CASE WHEN T1._Q_000_F_000_TYPE = 0x08 AND 
T1._Q_000_F_000_RTRef = 0x00000045 THEN T2._Fld1027 WHEN T1._Q_000_F_000_TYPE = 0x08 AND T1._Q_000_F_000_RTRef = 0x00000044 THEN T3._Fld1019 WHEN T1._Q_000_F_000_TYPE = 0x08 AND T1._Q_000_F_000_RTRef = 0x00000043 THEN 
T4._Fld1011 ELSE CAST(NULL AS NVARCHAR(MAX)) END) AS NUMERIC(12, 0)) > 0.0) THEN N''Детский клуб'' WHEN (CAST(CHARINDEX(N''Единоборства'',CASE WHEN T1._Q_000_F_000_TYPE = 0x08 AND T1._Q_000_F_000_RTRef = 0x00000045 THEN 
T2._Fld1027 WHEN T1._Q_000_F_000_TYPE = 0x08 AND T1._Q_000_F_000_RTRef = 0x00000044 THEN T3._Fld1019 WHEN T1._Q_000_F_000_TYPE = 0x08 AND T1._Q_000_F_000_RTRef = 0x00000043 THEN T4._Fld1011 ELSE CAST(NULL AS NVARCHAR(MAX)) END) AS NUMERIC(12, 0)) > 0.0) THEN N''Единоборства'' WHEN (CAST(CHARINDEX(N''Игровые виды'',CASE WHEN T1._Q_000_F_000_TYPE = 0x08 AND T1._Q_000_F_000_RTRef = 0x00000045 THEN T2._Fld1027 WHEN T1._Q_000_F_000_TYPE = 0x08 AND T1._Q_000_F_000_RTRef = 0x00000044 THEN T3._Fld1019 WHEN T1._Q_000_F_000_TYPE = 0x08 AND T1._Q_000_F_000_RTRef = 0x00000043 THEN T4._Fld1011 ELSE CAST(NULL AS NVARCHAR(MAX)) END) AS NUMERIC(12, 0)) > 0.0) THEN N''Игровые виды'' WHEN (CAST(CHARINDEX(N''Массаж'',CASE WHEN T1._Q_000_F_000_TYPE = 0x08 AND T1._Q_000_F_000_RTRef = 0x00000045 THEN T2._Fld1027 WHEN T1._Q_000_F_000_TYPE = 0x08 AND T1._Q_000_F_000_RTRef = 0x00000044 THEN T3._Fld1019 WHEN T1._Q_000_F_000_TYPE = 0x08 AND T1._Q_000_F_000_RTRef = 0x00000043 THEN T4._Fld1011 ELSE CAST(NULL AS NVARCHAR(MAX)) END) AS NUMERIC(12, 0)) > 0.0) THEN N''Массаж'' WHEN (CAST(CHARINDEX(N''Тренажерный зал'',CASE WHEN T1._Q_000_F_000_TYPE = 0x08 AND T1._Q_000_F_000_RTRef = 0x00000045 THEN T2._Fld1027 WHEN T1._Q_000_F_000_TYPE = 0x08 AND T1._Q_000_F_000_RTRef = 0x00000044 THEN T3._Fld1019 WHEN T1._Q_000_F_000_TYPE = 0x08 AND T1._Q_000_F_000_RTRef = 0x00000043 THEN T4._Fld1011 ELSE CAST(NULL AS NVARCHAR(MAX)) END) AS NUMERIC(12, 0)) > 0.0) THEN N''Тренажерный зал'' WHEN (CAST(CHARINDEX(N''Мед. услуги'',CASE WHEN T1._Q_000_F_000_TYPE = 0x08 AND T1._Q_000_F_000_RTRef = 0x00000045 THEN T2._Fld1027 WHEN T1._Q_000_F_000_TYPE = 0x08 AND T1._Q_000_F_000_RTRef = 0x00000044 THEN T3._Fld1019 WHEN T1._Q_000_F_000_TYPE = 0x08 AND T1._Q_000_F_000_RTRef = 0x00000043 THEN T4._Fld1011 ELSE CAST(NULL AS NVARCHAR(MAX)) END) AS NUMERIC(12, 0)) > 0.0) THEN N''Мед. услуги'' ELSE N''Другое'' END',N'@P1 nvarchar(4000),@P2 numeric(10),@P3 numeric(10),@P4 numeric(10)',N'denso',0,0,0

--select *
--from ##DWH_Workouts1

delete
from	DWH.[dbo].[Workouts]
where	[Date] between dateadd(year,-2000,@DateStart) and dateadd(year,-2000,@DateEnd)




INSERT INTO DWH.[dbo].[Workouts]
           ([Date]
           ,[SegmentID]
           ,[ClubID]
           ,[WorkoutID]
           ,[ServiceType]
		   ,[Department]
           ,[ItemID]
           ,[ManagerID]
           ,[Visitors])
select	dateadd(year,-2000,t.[Date]),
		sys.fn_varbintohexstr(t.[SegmentID]),
		sys.fn_varbintohexstr(t.[ClubID]),
		t.[WorkoutID],
		t.[ServiceType],
		t.Department,
		sys.fn_varbintohexstr(t.ServiceID),
		sys.fn_varbintohexstr(t.[ManagerID]),
		t.[Visitors]
from	##DWH_Workouts1 t



drop table ##DWH_tt292
drop table ##DWH_Workouts1


END
GO
