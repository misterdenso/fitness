SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
ALTER PROCEDURE [dbo].[UpdateFacts]
	@DateStart datetime2(3),
	@DateEnd datetime2(3)
AS
BEGIN


--declare @DateStart datetime2(3)123
--declare @DateEnd datetime2(3)


--set @DateStart='40220101'
--set @DateEnd='40220201'

select	@DateStart = dateadd(year,2000,@DateStart),
		@DateEnd = dateadd(year,2000,@DateEnd)



--КоэффициентСтрЕд
CREATE TABLE #tt262(_Q_000_F_000RRef binary(16), _Q_000_F_001 numeric(22, 3), _Q_000_F_002 nvarchar(10));

exec sp_executesql N'INSERT INTO #tt262 WITH(TABLOCK) (_Q_000_F_000RRef, _Q_000_F_001, _Q_000_F_002) SELECT
T1._IDRRef,
CASE WHEN (T1._Code = @P1) THEN @P2 WHEN (T1._Code = @P3) THEN @P4 WHEN (T1._Code = @P5) THEN @P6 ELSE @P7 END,
@P8
FROM dbo._Reference79X1 T1
WHERE (T1._Fld4704 = @P9)',N'@P1 nvarchar(4000),@P2 numeric(38,8),@P3 nvarchar(4000),@P4 numeric(38,8),@P5 nvarchar(4000),@P6 numeric(38,8),@P7 numeric(10),@P8 nvarchar(4000),@P9 numeric(10)',N'000000001',0.30000000,N'000000002',0.40000000,N'000000003',0.30000000,0,N'denso',0

--select * from #tt262



--СегментВездеход
CREATE TABLE #tt263(_Q_000_F_000RRef binary(16), _Q_000_F_001 nvarchar(10));
exec sp_executesql N'INSERT INTO #tt263 WITH(TABLOCK) (_Q_000_F_000RRef, _Q_000_F_001) SELECT
T1._IDRRef,
@P1
FROM dbo._Reference68 T1
WHERE ((T1._Fld4704 = @P2)) AND ((T1._Description = @P3))',N'@P1 nvarchar(4000),@P2 numeric(10),@P3 nvarchar(4000)',N'denso',0,N'КартыВездеход'

--select * from #tt263


--КоэффициентВездеход
CREATE TABLE #tt264(_Q_000_F_000_TYPE binary(1), _Q_000_F_000_RTRef binary(16), _Q_000_F_000_RRRef binary(16),_Q_000_F_001RRef binary(16),
_Q_000_F_002 numeric(22, 3),_Q_000_F_003 binary(1),_Q_000_F_004 nvarchar(10));

exec sp_executesql N'
INSERT INTO #tt264 WITH(TABLOCK) (_Q_000_F_000_TYPE, _Q_000_F_000_RTRef, _Q_000_F_000_RRRef, _Q_000_F_001RRef, _Q_000_F_002, _Q_000_F_003, _Q_000_F_004) 
SELECT
CASE WHEN T1._Fld3024_TYPE = 0x08 AND T1._Fld3024_RTRef = 0x0000007D THEN T2._Fld2239_TYPE ELSE CAST(NULL AS BINARY(1)) END,
CASE WHEN T1._Fld3024_TYPE = 0x08 AND T1._Fld3024_RTRef = 0x0000007D THEN T2._Fld2239_RTRef ELSE CAST(NULL AS BINARY(4)) END,
CASE WHEN T1._Fld3024_TYPE = 0x08 AND T1._Fld3024_RTRef = 0x0000007D THEN T2._Fld2239_RRRef ELSE CAST(NULL AS BINARY(16)) END,
T5._Q_000_F_000RRef,
T5._Q_000_F_001,
0x01,
@P1
FROM dbo._InfoRg3022 T1
LEFT OUTER JOIN dbo._Document125X1 T2
ON (T1._Fld3024_TYPE = 0x08 AND T1._Fld3024_RTRef = 0x0000007D AND T1._Fld3024_RRRef = T2._IDRRef) AND (T2._Fld4704 = @P2)
INNER JOIN dbo._InfoRg2977 T3
INNER JOIN #tt263 T4 WITH(NOLOCK)
ON (T3._Fld2978_TYPE = CASE WHEN T4._Q_000_F_000RRef IS NOT NULL THEN 0x08 END AND T3._Fld2978_RTRef = CASE WHEN T4._Q_000_F_000RRef IS NOT NULL THEN 0x00000044 END AND T3._Fld2978_RRRef = T4._Q_000_F_000RRef)
ON (CASE WHEN CASE WHEN T1._Fld3024_TYPE = 0x08 AND T1._Fld3024_RTRef = 0x0000007D THEN T2._Fld2251RRef ELSE CAST(NULL AS BINARY(16)) END IS NOT NULL THEN 0x08 END = T3._Fld2979_TYPE AND CASE WHEN CASE WHEN T1._Fld3024_TYPE = 0x08 AND T1._Fld3024_RTRef = 0x0000007D THEN T2._Fld2251RRef ELSE CAST(NULL AS BINARY(16)) END IS NOT NULL THEN 0x00000038 END = T3._Fld2979_RTRef AND CASE WHEN T1._Fld3024_TYPE = 0x08 AND T1._Fld3024_RTRef = 0x0000007D THEN T2._Fld2251RRef ELSE CAST(NULL AS BINARY(16)) END = T3._Fld2979_RRRef)
INNER JOIN #tt262 T5 WITH(NOLOCK)
ON 1=1
WHERE (((T1._Fld4704 = @P3)) AND (T3._Fld4704 = @P4)) AND ((T1._Fld3024_TYPE = 0x08 AND T1._Fld3024_RTRef = 0x0000007D))
GROUP BY CASE WHEN T1._Fld3024_TYPE = 0x08 AND T1._Fld3024_RTRef = 0x0000007D THEN T2._Fld2239_TYPE ELSE CAST(NULL AS BINARY(1)) END,
CASE WHEN T1._Fld3024_TYPE = 0x08 AND T1._Fld3024_RTRef = 0x0000007D THEN T2._Fld2239_RTRef ELSE CAST(NULL AS BINARY(4)) END,
CASE WHEN T1._Fld3024_TYPE = 0x08 AND T1._Fld3024_RTRef = 0x0000007D THEN T2._Fld2239_RRRef ELSE CAST(NULL AS BINARY(16)) END,
T5._Q_000_F_000RRef,
T5._Q_000_F_001',N'@P1 nvarchar(4000),@P2 numeric(10),@P3 numeric(10),@P4 numeric(10)',N'denso',0,0,0

--select * from #tt264


-- ПоступлениеДС
CREATE TABLE #tt265(_Q_000_F_000_TYPE binary(1), 
_Q_000_F_000_RTRef binary(16), _Q_000_F_000_RRRef binary(16), 
_Q_000_F_001 numeric(22, 3), _Q_000_F_002RRef binary(16), _Q_000_F_003_TYPE binary(1), 
_Q_000_F_003_RTRef binary(16), _Q_000_F_003_RRRef binary(16), 
_Q_000_F_004 datetime, _Q_000_F_005 datetime, _Q_000_F_006 nvarchar(10));

exec sp_executesql N'INSERT INTO #tt265 WITH(TABLOCK) (_Q_000_F_000_TYPE, _Q_000_F_000_RTRef, _Q_000_F_000_RRRef, _Q_000_F_001, _Q_000_F_002RRef, _Q_000_F_003_TYPE, _Q_000_F_003_RTRef, _Q_000_F_003_RRRef, _Q_000_F_004, _Q_000_F_005, _Q_000_F_006) 
SELECT
T1._Fld3299_TYPE,
T1._Fld3299_RTRef,
T1._Fld3299_RRRef,
CAST(CAST(SUM(T1._Fld3302) AS NUMERIC(21, 3)) AS NUMERIC(22, 3)),
CASE WHEN T1._RecorderTRef = 0x00000067 THEN T2._Fld1613RRef WHEN T1._RecorderTRef = 0x00000079 THEN T3._Fld2113RRef WHEN T1._RecorderTRef = 0x00000075 THEN T4._Fld1967RRef WHEN T1._RecorderTRef = 0x00000F37 THEN T5._Fld3897RRef WHEN T1._RecorderTRef = 0x00000072 THEN T6._Fld1871RRef WHEN T1._RecorderTRef = 0x00000061 THEN T7._Fld1411RRef WHEN T1._RecorderTRef = 0x00000069 THEN T8._Fld1648RRef WHEN T1._RecorderTRef = 0x00000073 THEN T9._Fld1909RRef WHEN T1._RecorderTRef = 0x00000F6A THEN T10._Fld3948RRef WHEN T1._RecorderTRef = 0x0000007D THEN T11._Fld2263RRef WHEN T1._RecorderTRef = 0x00000063 THEN T12._Fld1510RRef WHEN T1._RecorderTRef = 0x0000005F THEN T13._Fld1343RRef WHEN T1._RecorderTRef = 0x00000070 THEN T14._Fld1836RRef WHEN T1._RecorderTRef = 0x00000078 THEN T15._Fld2084RRef WHEN T1._RecorderTRef = 0x00000062 THEN T16._Fld1433RRef ELSE CAST(NULL AS BINARY(16)) END,
T1._Fld3298_TYPE,
T1._Fld3298_RTRef,
T1._Fld3298_RRRef,
DATEADD(DAY,CAST(DATEPART(DAY,T1._Period) AS NUMERIC(4)) - 1,DATEADD(MONTH,CAST(DATEPART(MONTH,T1._Period) AS NUMERIC(4)) - 1,DATEADD(YEAR,(CAST(DATEPART(YEAR,T1._Period) AS NUMERIC(4)) - 2000) - 2000,{ts ''4000-01-01 00:00:00''}))),
CASE WHEN T1._Fld3299_TYPE = 0x08 AND T1._Fld3299_RTRef = 0x00000075 THEN T17._Date_Time WHEN T1._Fld3299_TYPE = 0x08 AND T1._Fld3299_RTRef = 0x00000061 THEN T18._Date_Time WHEN T1._Fld3299_TYPE = 0x08 AND T1._Fld3299_RTRef = 0x00000069 THEN T19._Date_Time WHEN T1._Fld3299_TYPE = 0x08 AND T1._Fld3299_RTRef = 0x0000006D THEN T20._Date_Time WHEN T1._Fld3299_TYPE = 0x08 AND T1._Fld3299_RTRef = 0x00000F6A THEN T21._Date_Time WHEN T1._Fld3299_TYPE = 0x08 AND T1._Fld3299_RTRef = 0x00000062 THEN T22._Date_Time ELSE CAST(NULL AS DATETIME) END,
@P1
FROM dbo._AccumRg3296 T1
LEFT OUTER JOIN dbo._Document103 T2
ON (T1._RecorderTRef = 0x00000067 AND T1._RecorderRRef = T2._IDRRef) AND (T2._Fld4704 = @P2)
LEFT OUTER JOIN dbo._Document121 T3
ON (T1._RecorderTRef = 0x00000079 AND T1._RecorderRRef = T3._IDRRef) AND (T3._Fld4704 = @P3)
LEFT OUTER JOIN dbo._Document117 T4
ON (T1._RecorderTRef = 0x00000075 AND T1._RecorderRRef = T4._IDRRef) AND (T4._Fld4704 = @P4)
LEFT OUTER JOIN dbo._Document3895 T5
ON (T1._RecorderTRef = 0x00000F37 AND T1._RecorderRRef = T5._IDRRef) AND (T5._Fld4704 = @P5)
LEFT OUTER JOIN dbo._Document114 T6
ON (T1._RecorderTRef = 0x00000072 AND T1._RecorderRRef = T6._IDRRef) AND (T6._Fld4704 = @P6)
LEFT OUTER JOIN dbo._Document97 T7
ON (T1._RecorderTRef = 0x00000061 AND T1._RecorderRRef = T7._IDRRef) AND (T7._Fld4704 = @P7)
LEFT OUTER JOIN dbo._Document105X1 T8
ON (T1._RecorderTRef = 0x00000069 AND T1._RecorderRRef = T8._IDRRef) AND (T8._Fld4704 = @P8)
LEFT OUTER JOIN dbo._Document115X1 T9
ON (T1._RecorderTRef = 0x00000073 AND T1._RecorderRRef = T9._IDRRef) AND (T9._Fld4704 = @P9)
LEFT OUTER JOIN dbo._Document3946 T10
ON (T1._RecorderTRef = 0x00000F6A AND T1._RecorderRRef = T10._IDRRef) AND (T10._Fld4704 = @P10)
LEFT OUTER JOIN dbo._Document125X1 T11
ON (T1._RecorderTRef = 0x0000007D AND T1._RecorderRRef = T11._IDRRef) AND (T11._Fld4704 = @P11)
LEFT OUTER JOIN dbo._Document99 T12
ON (T1._RecorderTRef = 0x00000063 AND T1._RecorderRRef = T12._IDRRef) AND (T12._Fld4704 = @P12)
LEFT OUTER JOIN dbo._Document95 T13
ON (T1._RecorderTRef = 0x0000005F AND T1._RecorderRRef = T13._IDRRef) AND (T13._Fld4704 = @P13)
LEFT OUTER JOIN dbo._Document112 T14
ON (T1._RecorderTRef = 0x00000070 AND T1._RecorderRRef = T14._IDRRef) AND (T14._Fld4704 = @P14)
LEFT OUTER JOIN dbo._Document120 T15
ON (T1._RecorderTRef = 0x00000078 AND T1._RecorderRRef = T15._IDRRef) AND (T15._Fld4704 = @P15)
LEFT OUTER JOIN dbo._Document98 T16
ON (T1._RecorderTRef = 0x00000062 AND T1._RecorderRRef = T16._IDRRef) AND (T16._Fld4704 = @P16)
LEFT OUTER JOIN dbo._Document117 T17
ON (T1._Fld3299_TYPE = 0x08 AND T1._Fld3299_RTRef = 0x00000075 AND T1._Fld3299_RRRef = T17._IDRRef) AND (T17._Fld4704 = @P17)
LEFT OUTER JOIN dbo._Document97 T18
ON (T1._Fld3299_TYPE = 0x08 AND T1._Fld3299_RTRef = 0x00000061 AND T1._Fld3299_RRRef = T18._IDRRef) AND (T18._Fld4704 = @P18)
LEFT OUTER JOIN dbo._Document105X1 T19
ON (T1._Fld3299_TYPE = 0x08 AND T1._Fld3299_RTRef = 0x00000069 AND T1._Fld3299_RRRef = T19._IDRRef) AND (T19._Fld4704 = @P19)
LEFT OUTER JOIN dbo._Document109 T20
ON (T1._Fld3299_TYPE = 0x08 AND T1._Fld3299_RTRef = 0x0000006D AND T1._Fld3299_RRRef = T20._IDRRef) AND (T20._Fld4704 = @P20)
LEFT OUTER JOIN dbo._Document3946 T21
ON (T1._Fld3299_TYPE = 0x08 AND T1._Fld3299_RTRef = 0x00000F6A AND T1._Fld3299_RRRef = T21._IDRRef) AND (T21._Fld4704 = @P21)
LEFT OUTER JOIN dbo._Document98 T22
ON (T1._Fld3299_TYPE = 0x08 AND T1._Fld3299_RTRef = 0x00000062 AND T1._Fld3299_RRRef = T22._IDRRef) AND (T22._Fld4704 = @P22)
WHERE ((T1._Fld4704 = @P23)) AND ((T1._Period >= @P24) AND (T1._Period <= @P25) AND (T1._RecordKind = @P26) AND (T1._Fld3299_TYPE = 0x08 AND T1._Fld3299_RTRef = 0x00000075))
GROUP BY T1._Fld3299_TYPE,
T1._Fld3299_RTRef,
T1._Fld3299_RRRef,
CASE WHEN T1._RecorderTRef = 0x00000067 THEN T2._Fld1613RRef WHEN T1._RecorderTRef = 0x00000079 THEN T3._Fld2113RRef WHEN T1._RecorderTRef = 0x00000075 THEN T4._Fld1967RRef WHEN T1._RecorderTRef = 0x00000F37 THEN T5._Fld3897RRef WHEN T1._RecorderTRef = 0x00000072 THEN T6._Fld1871RRef WHEN T1._RecorderTRef = 0x00000061 THEN T7._Fld1411RRef WHEN T1._RecorderTRef = 0x00000069 THEN T8._Fld1648RRef WHEN T1._RecorderTRef = 0x00000073 THEN T9._Fld1909RRef WHEN T1._RecorderTRef = 0x00000F6A THEN T10._Fld3948RRef WHEN T1._RecorderTRef = 0x0000007D THEN T11._Fld2263RRef WHEN T1._RecorderTRef = 0x00000063 THEN T12._Fld1510RRef WHEN T1._RecorderTRef = 0x0000005F THEN T13._Fld1343RRef WHEN T1._RecorderTRef = 0x00000070 THEN T14._Fld1836RRef WHEN T1._RecorderTRef = 0x00000078 THEN T15._Fld2084RRef WHEN T1._RecorderTRef = 0x00000062 THEN T16._Fld1433RRef ELSE CAST(NULL AS BINARY(16)) END,
T1._Fld3298_TYPE,
T1._Fld3298_RTRef,
T1._Fld3298_RRRef,
DATEADD(DAY,CAST(DATEPART(DAY,T1._Period) AS NUMERIC(4)) - 1,DATEADD(MONTH,CAST(DATEPART(MONTH,T1._Period) AS NUMERIC(4)) - 1,DATEADD(YEAR,(CAST(DATEPART(YEAR,T1._Period) AS NUMERIC(4)) - 2000) - 2000,{ts ''4000-01-01 00:00:00''}))),
CASE WHEN T1._Fld3299_TYPE = 0x08 AND T1._Fld3299_RTRef = 0x00000075 THEN T17._Date_Time WHEN T1._Fld3299_TYPE = 0x08 AND T1._Fld3299_RTRef = 0x00000061 THEN T18._Date_Time WHEN T1._Fld3299_TYPE = 0x08 AND T1._Fld3299_RTRef = 0x00000069 THEN T19._Date_Time WHEN T1._Fld3299_TYPE = 0x08 AND T1._Fld3299_RTRef = 0x0000006D THEN T20._Date_Time WHEN T1._Fld3299_TYPE = 0x08 AND T1._Fld3299_RTRef = 0x00000F6A THEN T21._Date_Time WHEN T1._Fld3299_TYPE = 0x08 AND T1._Fld3299_RTRef = 0x00000062 THEN T22._Date_Time ELSE CAST(NULL AS DATETIME) END
HAVING (CAST(SUM(T1._Fld3302) AS NUMERIC(21, 3)) <> 0.0)
UNION ALL SELECT
T24._Fld1936_TYPE,
T24._Fld1936_RTRef,
T24._Fld1936_RRRef,
(-1.0 * CAST(SUM(T23._Fld3302) AS NUMERIC(21, 3))),
CASE WHEN T23._RecorderTRef = 0x00000067 THEN T25._Fld1613RRef WHEN T23._RecorderTRef = 0x00000079 THEN T26._Fld2113RRef WHEN T23._RecorderTRef = 0x00000075 THEN T27._Fld1967RRef WHEN T23._RecorderTRef = 0x00000F37 THEN T28._Fld3897RRef WHEN T23._RecorderTRef = 0x00000072 THEN T29._Fld1871RRef WHEN T23._RecorderTRef = 0x00000061 THEN T30._Fld1411RRef WHEN T23._RecorderTRef = 0x00000069 THEN T31._Fld1648RRef WHEN T23._RecorderTRef = 0x00000073 THEN T32._Fld1909RRef WHEN T23._RecorderTRef = 0x00000F6A THEN T33._Fld3948RRef WHEN T23._RecorderTRef = 0x0000007D THEN T34._Fld2263RRef WHEN T23._RecorderTRef = 0x00000063 THEN T35._Fld1510RRef WHEN T23._RecorderTRef = 0x0000005F THEN T36._Fld1343RRef WHEN T23._RecorderTRef = 0x00000070 THEN T37._Fld1836RRef WHEN T23._RecorderTRef = 0x00000078 THEN T38._Fld2084RRef WHEN T23._RecorderTRef = 0x00000062 THEN T39._Fld1433RRef ELSE CAST(NULL AS BINARY(16)) END,
T23._Fld3298_TYPE,
T23._Fld3298_RTRef,
T23._Fld3298_RRRef,
DATEADD(DAY,CAST(DATEPART(DAY,T23._Period) AS NUMERIC(4)) - 1,DATEADD(MONTH,CAST(DATEPART(MONTH,T23._Period) AS NUMERIC(4)) - 1,DATEADD(YEAR,(CAST(DATEPART(YEAR,T23._Period) AS NUMERIC(4)) - 2000) - 2000,{ts ''4000-01-01 00:00:00''}))),
CASE WHEN T24._Fld1936_TYPE = 0x08 AND T24._Fld1936_RTRef = 0x00000075 THEN T40._Date_Time WHEN T24._Fld1936_TYPE = 0x08 AND T24._Fld1936_RTRef = 0x0000006C THEN T41._Date_Time WHEN T24._Fld1936_TYPE = 0x08 AND T24._Fld1936_RTRef = 0x00000064 THEN T42._Date_Time WHEN T24._Fld1936_TYPE = 0x08 AND T24._Fld1936_RTRef = 0x00000073 THEN T43._Date_Time WHEN T24._Fld1936_TYPE = 0x08 AND T24._Fld1936_RTRef = 0x00000063 THEN T44._Date_Time WHEN T24._Fld1936_TYPE = 0x08 AND T24._Fld1936_RTRef = 0x00000078 THEN T45._Date_Time WHEN T24._Fld1936_TYPE = 0x08 AND T24._Fld1936_RTRef = 0x00000062 THEN T46._Date_Time ELSE CAST(NULL AS DATETIME) END,
@P27
FROM dbo._AccumRg3296 T23
INNER JOIN dbo._Document115_VT1934X1 T24
ON (T23._RecorderTRef = 0x00000073 AND T23._RecorderRRef = T24._Document115_IDRRef)
LEFT OUTER JOIN dbo._Document103 T25
ON (T23._RecorderTRef = 0x00000067 AND T23._RecorderRRef = T25._IDRRef) AND (T25._Fld4704 = @P28)
LEFT OUTER JOIN dbo._Document121 T26
ON (T23._RecorderTRef = 0x00000079 AND T23._RecorderRRef = T26._IDRRef) AND (T26._Fld4704 = @P29)
LEFT OUTER JOIN dbo._Document117 T27
ON (T23._RecorderTRef = 0x00000075 AND T23._RecorderRRef = T27._IDRRef) AND (T27._Fld4704 = @P30)
LEFT OUTER JOIN dbo._Document3895 T28
ON (T23._RecorderTRef = 0x00000F37 AND T23._RecorderRRef = T28._IDRRef) AND (T28._Fld4704 = @P31)
LEFT OUTER JOIN dbo._Document114 T29
ON (T23._RecorderTRef = 0x00000072 AND T23._RecorderRRef = T29._IDRRef) AND (T29._Fld4704 = @P32)
LEFT OUTER JOIN dbo._Document97 T30
ON (T23._RecorderTRef = 0x00000061 AND T23._RecorderRRef = T30._IDRRef) AND (T30._Fld4704 = @P33)
LEFT OUTER JOIN dbo._Document105X1 T31
ON (T23._RecorderTRef = 0x00000069 AND T23._RecorderRRef = T31._IDRRef) AND (T31._Fld4704 = @P34)
LEFT OUTER JOIN dbo._Document115X1 T32
ON (T23._RecorderTRef = 0x00000073 AND T23._RecorderRRef = T32._IDRRef) AND (T32._Fld4704 = @P35)
LEFT OUTER JOIN dbo._Document3946 T33
ON (T23._RecorderTRef = 0x00000F6A AND T23._RecorderRRef = T33._IDRRef) AND (T33._Fld4704 = @P36)
LEFT OUTER JOIN dbo._Document125X1 T34
ON (T23._RecorderTRef = 0x0000007D AND T23._RecorderRRef = T34._IDRRef) AND (T34._Fld4704 = @P37)
LEFT OUTER JOIN dbo._Document99 T35
ON (T23._RecorderTRef = 0x00000063 AND T23._RecorderRRef = T35._IDRRef) AND (T35._Fld4704 = @P38)
LEFT OUTER JOIN dbo._Document95 T36
ON (T23._RecorderTRef = 0x0000005F AND T23._RecorderRRef = T36._IDRRef) AND (T36._Fld4704 = @P39)
LEFT OUTER JOIN dbo._Document112 T37
ON (T23._RecorderTRef = 0x00000070 AND T23._RecorderRRef = T37._IDRRef) AND (T37._Fld4704 = @P40)
LEFT OUTER JOIN dbo._Document120 T38
ON (T23._RecorderTRef = 0x00000078 AND T23._RecorderRRef = T38._IDRRef) AND (T38._Fld4704 = @P41)
LEFT OUTER JOIN dbo._Document98 T39
ON (T23._RecorderTRef = 0x00000062 AND T23._RecorderRRef = T39._IDRRef) AND (T39._Fld4704 = @P42)
LEFT OUTER JOIN dbo._Document117 T40
ON (T24._Fld1936_TYPE = 0x08 AND T24._Fld1936_RTRef = 0x00000075 AND T24._Fld1936_RRRef = T40._IDRRef) AND (T40._Fld4704 = @P43)
LEFT OUTER JOIN dbo._Document108X1 T41
ON (T24._Fld1936_TYPE = 0x08 AND T24._Fld1936_RTRef = 0x0000006C AND T24._Fld1936_RRRef = T41._IDRRef) AND (T41._Fld4704 = @P44)
LEFT OUTER JOIN dbo._Document100 T42
ON (T24._Fld1936_TYPE = 0x08 AND T24._Fld1936_RTRef = 0x00000064 AND T24._Fld1936_RRRef = T42._IDRRef) AND (T42._Fld4704 = @P45)
LEFT OUTER JOIN dbo._Document115X1 T43
ON (T24._Fld1936_TYPE = 0x08 AND T24._Fld1936_RTRef = 0x00000073 AND T24._Fld1936_RRRef = T43._IDRRef) AND (T43._Fld4704 = @P46)
LEFT OUTER JOIN dbo._Document99 T44
ON (T24._Fld1936_TYPE = 0x08 AND T24._Fld1936_RTRef = 0x00000063 AND T24._Fld1936_RRRef = T44._IDRRef) AND (T44._Fld4704 = @P47)
LEFT OUTER JOIN dbo._Document120 T45
ON (T24._Fld1936_TYPE = 0x08 AND T24._Fld1936_RTRef = 0x00000078 AND T24._Fld1936_RRRef = T45._IDRRef) AND (T45._Fld4704 = @P48)
LEFT OUTER JOIN dbo._Document98 T46
ON (T24._Fld1936_TYPE = 0x08 AND T24._Fld1936_RTRef = 0x00000062 AND T24._Fld1936_RRRef = T46._IDRRef) AND (T46._Fld4704 = @P49)
WHERE (((T23._Fld4704 = @P50)) AND (T24._Fld4704 = @P51)) AND ((T23._Period >= @P52) AND (T23._Period <= @P53) AND (T23._Fld3302 > @P54) AND (T23._RecordKind = @P55) AND (T23._Fld3300RRef = @P56) AND (T24._Fld1936_TYPE = 0x08 AND T24._Fld1936_RTRef = 0x00000075))
GROUP BY T24._Fld1936_TYPE,
T24._Fld1936_RTRef,
T24._Fld1936_RRRef,
CASE WHEN T23._RecorderTRef = 0x00000067 THEN T25._Fld1613RRef WHEN T23._RecorderTRef = 0x00000079 THEN T26._Fld2113RRef WHEN T23._RecorderTRef = 0x00000075 THEN T27._Fld1967RRef WHEN T23._RecorderTRef = 0x00000F37 THEN T28._Fld3897RRef WHEN T23._RecorderTRef = 0x00000072 THEN T29._Fld1871RRef WHEN T23._RecorderTRef = 0x00000061 THEN T30._Fld1411RRef WHEN T23._RecorderTRef = 0x00000069 THEN T31._Fld1648RRef WHEN T23._RecorderTRef = 0x00000073 THEN T32._Fld1909RRef WHEN T23._RecorderTRef = 0x00000F6A THEN T33._Fld3948RRef WHEN T23._RecorderTRef = 0x0000007D THEN T34._Fld2263RRef WHEN T23._RecorderTRef = 0x00000063 THEN T35._Fld1510RRef WHEN T23._RecorderTRef = 0x0000005F THEN T36._Fld1343RRef WHEN T23._RecorderTRef = 0x00000070 THEN T37._Fld1836RRef WHEN T23._RecorderTRef = 0x00000078 THEN T38._Fld2084RRef WHEN T23._RecorderTRef = 0x00000062 THEN T39._Fld1433RRef ELSE CAST(NULL AS BINARY(16)) END,
T23._Fld3298_TYPE,
T23._Fld3298_RTRef,
T23._Fld3298_RRRef,
DATEADD(DAY,CAST(DATEPART(DAY,T23._Period) AS NUMERIC(4)) - 1,DATEADD(MONTH,CAST(DATEPART(MONTH,T23._Period) AS NUMERIC(4)) - 1,DATEADD(YEAR,(CAST(DATEPART(YEAR,T23._Period) AS NUMERIC(4)) - 2000) - 2000,{ts ''4000-01-01 00:00:00''}))),
CASE WHEN T24._Fld1936_TYPE = 0x08 AND T24._Fld1936_RTRef = 0x00000075 THEN T40._Date_Time WHEN T24._Fld1936_TYPE = 0x08 AND T24._Fld1936_RTRef = 0x0000006C THEN T41._Date_Time WHEN T24._Fld1936_TYPE = 0x08 AND T24._Fld1936_RTRef = 0x00000064 THEN T42._Date_Time WHEN T24._Fld1936_TYPE = 0x08 AND T24._Fld1936_RTRef = 0x00000073 THEN T43._Date_Time WHEN T24._Fld1936_TYPE = 0x08 AND T24._Fld1936_RTRef = 0x00000063 THEN T44._Date_Time WHEN T24._Fld1936_TYPE = 0x08 AND T24._Fld1936_RTRef = 0x00000078 THEN T45._Date_Time WHEN T24._Fld1936_TYPE = 0x08 AND T24._Fld1936_RTRef = 0x00000062 THEN T46._Date_Time ELSE CAST(NULL AS DATETIME) END
UNION ALL SELECT
T50._Fld1936_TYPE,
T50._Fld1936_RTRef,
T50._Fld1936_RRRef,
(-1.0 * CAST(SUM(T47._Fld3302) AS NUMERIC(21, 3))),
CASE WHEN T47._RecorderTRef = 0x00000067 THEN T56._Fld1613RRef WHEN T47._RecorderTRef = 0x00000079 THEN T57._Fld2113RRef WHEN T47._RecorderTRef = 0x00000075 THEN T58._Fld1967RRef WHEN T47._RecorderTRef = 0x00000F37 THEN T59._Fld3897RRef WHEN T47._RecorderTRef = 0x00000072 THEN T60._Fld1871RRef WHEN T47._RecorderTRef = 0x00000061 THEN T61._Fld1411RRef WHEN T47._RecorderTRef = 0x00000069 THEN T62._Fld1648RRef WHEN T47._RecorderTRef = 0x00000073 THEN T63._Fld1909RRef WHEN T47._RecorderTRef = 0x00000F6A THEN T64._Fld3948RRef WHEN T47._RecorderTRef = 0x0000007D THEN T65._Fld2263RRef WHEN T47._RecorderTRef = 0x00000063 THEN T66._Fld1510RRef WHEN T47._RecorderTRef = 0x0000005F THEN T67._Fld1343RRef WHEN T47._RecorderTRef = 0x00000070 THEN T68._Fld1836RRef WHEN T47._RecorderTRef = 0x00000078 THEN T69._Fld2084RRef WHEN T47._RecorderTRef = 0x00000062 THEN T70._Fld1433RRef ELSE CAST(NULL AS BINARY(16)) END,
T47._Fld3298_TYPE,
T47._Fld3298_RTRef,
T47._Fld3298_RRRef,
DATEADD(DAY,CAST(DATEPART(DAY,T47._Period) AS NUMERIC(4)) - 1,DATEADD(MONTH,CAST(DATEPART(MONTH,T47._Period) AS NUMERIC(4)) - 1,DATEADD(YEAR,(CAST(DATEPART(YEAR,T47._Period) AS NUMERIC(4)) - 2000) - 2000,{ts ''4000-01-01 00:00:00''}))),
CASE WHEN T50._Fld1936_TYPE = 0x08 AND T50._Fld1936_RTRef = 0x00000075 THEN T51._Date_Time WHEN T50._Fld1936_TYPE = 0x08 AND T50._Fld1936_RTRef = 0x0000006C THEN T71._Date_Time WHEN T50._Fld1936_TYPE = 0x08 AND T50._Fld1936_RTRef = 0x00000064 THEN T52._Date_Time WHEN T50._Fld1936_TYPE = 0x08 AND T50._Fld1936_RTRef = 0x00000073 THEN T53._Date_Time WHEN T50._Fld1936_TYPE = 0x08 AND T50._Fld1936_RTRef = 0x00000063 THEN T54._Date_Time WHEN T50._Fld1936_TYPE = 0x08 AND T50._Fld1936_RTRef = 0x00000078 THEN T55._Date_Time WHEN T50._Fld1936_TYPE = 0x08 AND T50._Fld1936_RTRef = 0x00000062 THEN T72._Date_Time ELSE CAST(NULL AS DATETIME) END,
@P57
FROM dbo._AccumRg3296 T47
INNER JOIN dbo._Document115_VT1934X1 T48
LEFT OUTER JOIN dbo._Document115X1 T49
ON (T48._Document115_IDRRef = T49._IDRRef) AND (T49._Fld4704 = @P58)
LEFT OUTER JOIN dbo._Document115_VT1934X1 T50
LEFT OUTER JOIN dbo._Document117 T51
ON (T50._Fld1936_TYPE = 0x08 AND T50._Fld1936_RTRef = 0x00000075 AND T50._Fld1936_RRRef = T51._IDRRef) AND (T51._Fld4704 = @P59)
LEFT OUTER JOIN dbo._Document100 T52
ON (T50._Fld1936_TYPE = 0x08 AND T50._Fld1936_RTRef = 0x00000064 AND T50._Fld1936_RRRef = T52._IDRRef) AND (T52._Fld4704 = @P60)
LEFT OUTER JOIN dbo._Document115X1 T53
ON (T50._Fld1936_TYPE = 0x08 AND T50._Fld1936_RTRef = 0x00000073 AND T50._Fld1936_RRRef = T53._IDRRef) AND (T53._Fld4704 = @P61)
LEFT OUTER JOIN dbo._Document99 T54
ON (T50._Fld1936_TYPE = 0x08 AND T50._Fld1936_RTRef = 0x00000063 AND T50._Fld1936_RRRef = T54._IDRRef) AND (T54._Fld4704 = @P62)
LEFT OUTER JOIN dbo._Document120 T55
ON (T50._Fld1936_TYPE = 0x08 AND T50._Fld1936_RTRef = 0x00000078 AND T50._Fld1936_RRRef = T55._IDRRef) AND (T55._Fld4704 = @P63)
ON ((T48._Fld1936_TYPE = CASE WHEN T50._Document115_IDRRef IS NOT NULL THEN 0x08 END AND T48._Fld1936_RTRef = CASE WHEN T50._Document115_IDRRef IS NOT NULL THEN 0x00000073 END AND T48._Fld1936_RRRef = T50._Document115_IDRRef) AND (T49._Fld1910_TYPE = CASE WHEN T50._Fld1936_TYPE = 0x08 AND T50._Fld1936_RTRef = 0x00000075 THEN CASE WHEN T51._Fld1969RRef IS NOT NULL THEN 0x08 END WHEN T50._Fld1936_TYPE = 0x08 AND T50._Fld1936_RTRef = 0x00000064 THEN CASE WHEN T52._Fld1551RRef IS NOT NULL THEN 0x08 END WHEN T50._Fld1936_TYPE = 0x08 AND T50._Fld1936_RTRef = 0x00000073 THEN T53._Fld1910_TYPE WHEN T50._Fld1936_TYPE = 0x08 AND T50._Fld1936_RTRef = 0x00000063 THEN CASE WHEN T54._Fld1511RRef IS NOT NULL THEN 0x08 END WHEN T50._Fld1936_TYPE = 0x08 AND T50._Fld1936_RTRef = 0x00000078 THEN T55._Fld2077_TYPE ELSE CAST(NULL AS BINARY(1)) END AND T49._Fld1910_RTRef = CASE WHEN T50._Fld1936_TYPE = 0x08 AND T50._Fld1936_RTRef = 0x00000075 THEN CASE WHEN T51._Fld1969RRef IS NOT NULL THEN 0x00000033 END WHEN T50._Fld1936_TYPE = 0x08 AND T50._Fld1936_RTRef = 0x00000064 THEN CASE WHEN T52._Fld1551RRef IS NOT NULL THEN 0x00000033 END WHEN T50._Fld1936_TYPE = 0x08 AND T50._Fld1936_RTRef = 0x00000073 THEN T53._Fld1910_RTRef WHEN T50._Fld1936_TYPE = 0x08 AND T50._Fld1936_RTRef = 0x00000063 THEN CASE WHEN T54._Fld1511RRef IS NOT NULL THEN 0x00000033 END WHEN T50._Fld1936_TYPE = 0x08 AND T50._Fld1936_RTRef = 0x00000078 THEN T55._Fld2077_RTRef ELSE CAST(NULL AS BINARY(4)) END AND T49._Fld1910_RRRef = CASE WHEN T50._Fld1936_TYPE = 0x08 AND T50._Fld1936_RTRef = 0x00000075 THEN T51._Fld1969RRef WHEN T50._Fld1936_TYPE = 0x08 AND T50._Fld1936_RTRef = 0x00000064 THEN T52._Fld1551RRef WHEN T50._Fld1936_TYPE = 0x08 AND T50._Fld1936_RTRef = 0x00000073 THEN T53._Fld1910_RRRef WHEN T50._Fld1936_TYPE = 0x08 AND T50._Fld1936_RTRef = 0x00000063 THEN T54._Fld1511RRef WHEN T50._Fld1936_TYPE = 0x08 AND T50._Fld1936_RTRef = 0x00000078 THEN T55._Fld2077_RRRef ELSE CAST(NULL AS BINARY(16)) END)) AND (T50._Fld4704 = @P64)
ON (T47._RecorderTRef = 0x00000073 AND T47._RecorderRRef = T48._Document115_IDRRef)
LEFT OUTER JOIN dbo._Document103 T56
ON (T47._RecorderTRef = 0x00000067 AND T47._RecorderRRef = T56._IDRRef) AND (T56._Fld4704 = @P65)
LEFT OUTER JOIN dbo._Document121 T57
ON (T47._RecorderTRef = 0x00000079 AND T47._RecorderRRef = T57._IDRRef) AND (T57._Fld4704 = @P66)
LEFT OUTER JOIN dbo._Document117 T58
ON (T47._RecorderTRef = 0x00000075 AND T47._RecorderRRef = T58._IDRRef) AND (T58._Fld4704 = @P67)
LEFT OUTER JOIN dbo._Document3895 T59
ON (T47._RecorderTRef = 0x00000F37 AND T47._RecorderRRef = T59._IDRRef) AND (T59._Fld4704 = @P68)
LEFT OUTER JOIN dbo._Document114 T60
ON (T47._RecorderTRef = 0x00000072 AND T47._RecorderRRef = T60._IDRRef) AND (T60._Fld4704 = @P69)
LEFT OUTER JOIN dbo._Document97 T61
ON (T47._RecorderTRef = 0x00000061 AND T47._RecorderRRef = T61._IDRRef) AND (T61._Fld4704 = @P70)
LEFT OUTER JOIN dbo._Document105X1 T62
ON (T47._RecorderTRef = 0x00000069 AND T47._RecorderRRef = T62._IDRRef) AND (T62._Fld4704 = @P71)
LEFT OUTER JOIN dbo._Document115X1 T63
ON (T47._RecorderTRef = 0x00000073 AND T47._RecorderRRef = T63._IDRRef) AND (T63._Fld4704 = @P72)
LEFT OUTER JOIN dbo._Document3946 T64
ON (T47._RecorderTRef = 0x00000F6A AND T47._RecorderRRef = T64._IDRRef) AND (T64._Fld4704 = @P73)
LEFT OUTER JOIN dbo._Document125X1 T65
ON (T47._RecorderTRef = 0x0000007D AND T47._RecorderRRef = T65._IDRRef) AND (T65._Fld4704 = @P74)
LEFT OUTER JOIN dbo._Document99 T66
ON (T47._RecorderTRef = 0x00000063 AND T47._RecorderRRef = T66._IDRRef) AND (T66._Fld4704 = @P75)
LEFT OUTER JOIN dbo._Document95 T67
ON (T47._RecorderTRef = 0x0000005F AND T47._RecorderRRef = T67._IDRRef) AND (T67._Fld4704 = @P76)
LEFT OUTER JOIN dbo._Document112 T68
ON (T47._RecorderTRef = 0x00000070 AND T47._RecorderRRef = T68._IDRRef) AND (T68._Fld4704 = @P77)
LEFT OUTER JOIN dbo._Document120 T69
ON (T47._RecorderTRef = 0x00000078 AND T47._RecorderRRef = T69._IDRRef) AND (T69._Fld4704 = @P78)
LEFT OUTER JOIN dbo._Document98 T70
ON (T47._RecorderTRef = 0x00000062 AND T47._RecorderRRef = T70._IDRRef) AND (T70._Fld4704 = @P79)
LEFT OUTER JOIN dbo._Document108X1 T71
ON (T50._Fld1936_TYPE = 0x08 AND T50._Fld1936_RTRef = 0x0000006C AND T50._Fld1936_RRRef = T71._IDRRef) AND (T71._Fld4704 = @P80)
LEFT OUTER JOIN dbo._Document98 T72
ON (T50._Fld1936_TYPE = 0x08 AND T50._Fld1936_RTRef = 0x00000062 AND T50._Fld1936_RRRef = T72._IDRRef) AND (T72._Fld4704 = @P81)
WHERE (((T47._Fld4704 = @P82)) AND (T48._Fld4704 = @P83)) AND ((T47._Period >= @P84) AND (T47._Period <= @P85) AND (T47._Fld3302 > @P86) AND (T47._RecordKind = @P87) AND (T47._Fld3300RRef = @P88) AND (T50._Fld1936_TYPE = 0x08 AND T50._Fld1936_RTRef = 0x00000075))
GROUP BY T50._Fld1936_TYPE,
T50._Fld1936_RTRef,
T50._Fld1936_RRRef,
CASE WHEN T47._RecorderTRef = 0x00000067 THEN T56._Fld1613RRef WHEN T47._RecorderTRef = 0x00000079 THEN T57._Fld2113RRef WHEN T47._RecorderTRef = 0x00000075 THEN T58._Fld1967RRef WHEN T47._RecorderTRef = 0x00000F37 THEN T59._Fld3897RRef WHEN T47._RecorderTRef = 0x00000072 THEN T60._Fld1871RRef WHEN T47._RecorderTRef = 0x00000061 THEN T61._Fld1411RRef WHEN T47._RecorderTRef = 0x00000069 THEN T62._Fld1648RRef WHEN T47._RecorderTRef = 0x00000073 THEN T63._Fld1909RRef WHEN T47._RecorderTRef = 0x00000F6A THEN T64._Fld3948RRef WHEN T47._RecorderTRef = 0x0000007D THEN T65._Fld2263RRef WHEN T47._RecorderTRef = 0x00000063 THEN T66._Fld1510RRef WHEN T47._RecorderTRef = 0x0000005F THEN T67._Fld1343RRef WHEN T47._RecorderTRef = 0x00000070 THEN T68._Fld1836RRef WHEN T47._RecorderTRef = 0x00000078 THEN T69._Fld2084RRef WHEN T47._RecorderTRef = 0x00000062 THEN T70._Fld1433RRef ELSE CAST(NULL AS BINARY(16)) END,
T47._RecorderTRef,
T47._RecorderRRef,
T47._Fld3298_TYPE,
T47._Fld3298_RTRef,
T47._Fld3298_RRRef,
DATEADD(DAY,CAST(DATEPART(DAY,T47._Period) AS NUMERIC(4)) - 1,DATEADD(MONTH,CAST(DATEPART(MONTH,T47._Period) AS NUMERIC(4)) - 1,DATEADD(YEAR,(CAST(DATEPART(YEAR,T47._Period) AS NUMERIC(4)) - 2000) - 2000,{ts ''4000-01-01 00:00:00''}))),
CASE WHEN T50._Fld1936_TYPE = 0x08 AND T50._Fld1936_RTRef = 0x00000075 THEN T51._Date_Time WHEN T50._Fld1936_TYPE = 0x08 AND T50._Fld1936_RTRef = 0x0000006C THEN T71._Date_Time WHEN T50._Fld1936_TYPE = 0x08 AND T50._Fld1936_RTRef = 0x00000064 THEN T52._Date_Time WHEN 
T50._Fld1936_TYPE = 0x08 AND T50._Fld1936_RTRef = 0x00000073 THEN T53._Date_Time WHEN T50._Fld1936_TYPE = 0x08 AND T50._Fld1936_RTRef = 0x00000063 THEN T54._Date_Time WHEN T50._Fld1936_TYPE = 0x08 AND T50._Fld1936_RTRef = 0x00000078 THEN T55._Date_Time WHEN 
T50._Fld1936_TYPE = 0x08 AND T50._Fld1936_RTRef = 0x00000062 THEN T72._Date_Time ELSE CAST(NULL AS DATETIME) END',N'@P1 nvarchar(4000),@P2 numeric(10),@P3 numeric(10),@P4 numeric(10),@P5 numeric(10),@P6 numeric(10),@P7 numeric(10),@P8 numeric(10),@P9 numeric(10),@P10 numeric(10),@P11 numeric(10),@P12 numeric(10),@P13 numeric(10),@P14 numeric(10),@P15 numeric(10),@P16 numeric(10),@P17 numeric(10),@P18 numeric(10),@P19 numeric(10),@P20 numeric(10),@P21 numeric(10),@P22 numeric(10),@P23 numeric(10),@P24 datetime2(3),@P25 datetime2(3),@P26 numeric(10),@P27 nvarchar(4000),@P28 numeric(10),@P29 numeric(10),@P30 numeric(10),@P31 numeric(10),@P32 numeric(10),@P33 numeric(10),@P34 numeric(10),@P35 numeric(10),@P36 numeric(10),@P37 numeric(10),@P38 numeric(10),@P39 numeric(10),@P40 numeric(10),@P41 numeric(10),@P42 numeric(10),@P43 numeric(10),@P44 numeric(10),@P45 numeric(10),@P46 numeric(10),@P47 numeric(10),@P48 numeric(10),@P49 numeric(10),@P50 numeric(10),@P51 numeric(10),@P52 datetime2(3),@P53 datetime2(3),@P54 numeric(10),@P55 numeric(10),@P56 varbinary(16),@P57 nvarchar(4000),@P58 numeric(10),@P59 numeric(10),@P60 numeric(10),@P61 numeric(10),@P62 numeric(10),@P63 numeric(10),@P64 numeric(10),@P65 numeric(10),@P66 numeric(10),@P67 numeric(10),@P68 numeric(10),@P69 numeric(10),@P70 numeric(10),@P71 numeric(10),@P72 numeric(10),@P73 numeric(10),@P74 numeric(10),@P75 numeric(10),@P76 numeric(10),@P77 numeric(10),@P78 numeric(10),@P79 numeric(10),@P80 numeric(10),@P81 numeric(10),@P82 numeric(10),@P83 numeric(10),@P84 datetime2(3),@P85 datetime2(3),@P86 numeric(10),@P87 numeric(10),@P88 varbinary(16)',
N'denso',
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,@DateStart ,@DateEnd,0,N'denso',0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,@DateStart,@DateEnd,
0,0,0xBC4D6045501420854473166B955392A3,N'denso',0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,@DateStart,@DateEnd,0,0,0xBC4D6045501420854473166B955392A3

--select * from #tt265

-- ПоступлениеДССумма
CREATE TABLE #tt266(
_Q_000_F_000_TYPE binary(1), _Q_000_F_000_RTRef binary(16), _Q_000_F_000_RRRef binary(16), _Q_000_F_001 numeric(22, 3), _Q_000_F_002RRef binary(16), _Q_000_F_003_TYPE binary(1), _Q_000_F_003_RTRef binary(16), 
_Q_000_F_003_RRRef binary(16), _Q_000_F_004 datetime, _Q_000_F_005 datetime, _Q_000_F_006 binary(1), _Q_000_F_007 nvarchar(10));

exec sp_executesql N'INSERT INTO #tt266 WITH(TABLOCK) (_Q_000_F_000_TYPE, _Q_000_F_000_RTRef, _Q_000_F_000_RRRef, _Q_000_F_001, _Q_000_F_002RRef, _Q_000_F_003_TYPE, _Q_000_F_003_RTRef, 
_Q_000_F_003_RRRef, _Q_000_F_004, _Q_000_F_005, _Q_000_F_006, _Q_000_F_007) 
SELECT
T1._Q_000_F_000_TYPE,
T1._Q_000_F_000_RTRef,
T1._Q_000_F_000_RRRef,
CAST(SUM((T1._Q_000_F_001 * ISNULL(CAST(T2._Q_000_F_002 AS NUMERIC(2, 1)),1.0))) AS NUMERIC(30, 4)),
ISNULL(T2._Q_000_F_001RRef,T1._Q_000_F_002RRef),
T1._Q_000_F_003_TYPE,
T1._Q_000_F_003_RTRef,
T1._Q_000_F_003_RRRef,
T1._Q_000_F_004,
T1._Q_000_F_005,
ISNULL(T2._Q_000_F_003,0x00),
@P1
FROM #tt265 T1 WITH(NOLOCK)
LEFT OUTER JOIN #tt264 T2 WITH(NOLOCK)
ON (T1._Q_000_F_000_TYPE = T2._Q_000_F_000_TYPE AND T1._Q_000_F_000_RTRef = T2._Q_000_F_000_RTRef AND T1._Q_000_F_000_RRRef = T2._Q_000_F_000_RRRef)
GROUP BY T1._Q_000_F_000_TYPE,
T1._Q_000_F_000_RTRef,
T1._Q_000_F_000_RRRef,
ISNULL(T2._Q_000_F_001RRef,T1._Q_000_F_002RRef),
T1._Q_000_F_003_TYPE,
T1._Q_000_F_003_RTRef,
T1._Q_000_F_003_RRRef,
T1._Q_000_F_004,
T1._Q_000_F_005,
ISNULL(T2._Q_000_F_003,0x00)',N'@P1 nvarchar(4000)',N'denso'


-- ПродажаСуммаДокумента
CREATE TABLE #tt267(_Q_000_F_000 NUMERIC(21, 2), _Q_000_F_001TRef binary(16), _Q_000_F_001RRef binary(16), _Q_000_F_002 NUMERIC(21, 2), _Q_000_F_003 nvarchar(10)) ;

exec sp_executesql N'INSERT INTO #tt267 WITH(TABLOCK) (_Q_000_F_000, _Q_000_F_001TRef, _Q_000_F_001RRef, _Q_000_F_002, _Q_000_F_003) 
SELECT DISTINCT
CAST(SUM(T1._Fld3232) AS NUMERIC(21, 2)),
T1._RecorderTRef,
T1._RecorderRRef,
CAST(SUM(T1._Fld3231) AS NUMERIC(21, 3)),
@P1
FROM dbo._AccumRg3221 T1
WHERE (T1._Fld4704 = @P2)
GROUP BY T1._RecorderTRef,
T1._RecorderRRef',N'@P1 nvarchar(4000),@P2 numeric(10)',N'denso',0



-- ПродажиКоличество
CREATE TABLE #tt268(_Q_000_F_000TRef binary(16), _Q_000_F_000RRef binary(16), _Q_000_F_001 NUMERIC(21, 3), 
_Q_000_F_002RRef binary(16), _Q_000_F_003RRef binary(16), _Q_000_F_004 datetime, 
_Q_000_F_005RRef binary(16), _Q_000_F_006RRef binary(16), _Q_000_F_007 datetime, 
_Q_000_F_008RRef binary(16), _Q_000_F_009_TYPE binary(1), _Q_000_F_009_RTRef binary(16), 
_Q_000_F_009_RRRef binary(16), _Q_000_F_010 nvarchar(10)) ;

exec sp_executesql N'INSERT INTO #tt268 WITH(TABLOCK) (_Q_000_F_000TRef, _Q_000_F_000RRef, _Q_000_F_001, _Q_000_F_002RRef, _Q_000_F_003RRef, _Q_000_F_004, _Q_000_F_005RRef, _Q_000_F_006RRef, _Q_000_F_007, _Q_000_F_008RRef, _Q_000_F_009_TYPE, _Q_000_F_009_RTRef, _Q_000_F_009_RRRef, _Q_000_F_010) 
SELECT
T1._RecorderTRef,
T1._RecorderRRef,
CAST(SUM(T1._Fld3231) AS NUMERIC(21, 3)),
T1._Fld3226RRef,
T1._Fld3225RRef,
DATEADD(DAY,CAST(DATEPART(DAY,T1._Period) AS NUMERIC(4)) - 1,DATEADD(MONTH,CAST(DATEPART(MONTH,T1._Period) AS NUMERIC(4)) - 1,DATEADD(YEAR,(CAST(DATEPART(YEAR,T1._Period) AS NUMERIC(4)) - 2000) - 2000,{ts ''4000-01-01 00:00:00''}))),
T1._Fld3224RRef,
T1._Fld3222RRef,
T1._Period,
T1._Fld4008RRef,
T1._Fld3229_TYPE,
T1._Fld3229_RTRef,
T1._Fld3229_RRRef,
@P1
FROM dbo._AccumRg3221 T1
LEFT OUTER JOIN dbo._Reference56X1 T2
ON (T1._Fld3226RRef = T2._IDRRef) AND (T2._Fld4704 = @P2)
WHERE ((T1._Fld4704 = @P3)) AND ((T1._Period >= @P4) AND (T1._Period <= @P5) AND (T2._Description <> @P6))
GROUP BY T1._RecorderTRef,
T1._RecorderRRef,
T1._Fld3226RRef,
T1._Fld3225RRef,
DATEADD(DAY,CAST(DATEPART(DAY,T1._Period) AS NUMERIC(4)) - 1,DATEADD(MONTH,CAST(DATEPART(MONTH,T1._Period) AS NUMERIC(4)) - 1,DATEADD(YEAR,(CAST(DATEPART(YEAR,T1._Period) AS NUMERIC(4)) - 2000) - 2000,{ts ''4000-01-01 00:00:00''}))),
T1._Fld3224RRef,
T1._Fld3222RRef,
T1._Period,
T1._Fld4008RRef,
T1._Fld3229_TYPE,
T1._Fld3229_RTRef,
T1._Fld3229_RRRef',
N'@P1 nvarchar(4000),@P2 numeric(10),@P3 numeric(10),@P4 datetime2(3),@P5 datetime2(3),@P6 nvarchar(4000)',
N'denso',0,0,@DateStart,@DateEnd,N'Карта сотрудника'



-- ВозвратДСВводНАчОстатков
CREATE TABLE #tt269(_Q_000_F_000RRef binary(16), _Q_000_F_001_TYPE binary(1), _Q_000_F_001_RTRef binary(16), 
_Q_000_F_001_RRRef binary(16), _Q_000_F_002 datetime, _Q_000_F_003RRef binary(16), 
_Q_000_F_004RRef binary(16), _Q_000_F_005 NUMERIC(21, 3), _Q_000_F_006 NUMERIC(21, 3), 
_Q_000_F_007_TYPE binary(1), _Q_000_F_007_RTRef binary(16), _Q_000_F_007_RRRef binary(16), _Q_000_F_008 nvarchar(10));

exec sp_executesql N'INSERT INTO #tt269 WITH(TABLOCK) (_Q_000_F_000RRef, _Q_000_F_001_TYPE, _Q_000_F_001_RTRef, 
_Q_000_F_001_RRRef, _Q_000_F_002, _Q_000_F_003RRef, 
_Q_000_F_004RRef, _Q_000_F_005, _Q_000_F_006, 
_Q_000_F_007_TYPE, _Q_000_F_007_RTRef, _Q_000_F_007_RRRef, _Q_000_F_008) 
SELECT
CASE WHEN T1._RecorderTRef = 0x00000067 THEN T4._Fld1613RRef WHEN T1._RecorderTRef = 0x00000079 THEN T5._Fld2113RRef WHEN T1._RecorderTRef = 0x00000075 THEN T6._Fld1967RRef WHEN T1._RecorderTRef = 0x00000F37 THEN T7._Fld3897RRef WHEN T1._RecorderTRef = 0x00000072 THEN T8._Fld1871RRef WHEN T1._RecorderTRef = 0x00000061 THEN T9._Fld1411RRef WHEN T1._RecorderTRef = 0x00000069 THEN T10._Fld1648RRef WHEN T1._RecorderTRef = 0x00000073 THEN T11._Fld1909RRef WHEN T1._RecorderTRef = 0x00000F6A THEN T12._Fld3948RRef WHEN T1._RecorderTRef = 0x0000007D THEN T13._Fld2263RRef WHEN T1._RecorderTRef = 0x00000063 THEN T14._Fld1510RRef WHEN T1._RecorderTRef = 0x0000005F THEN T15._Fld1343RRef WHEN T1._RecorderTRef = 0x00000070 THEN T16._Fld1836RRef WHEN T1._RecorderTRef = 0x00000078 THEN T17._Fld2084RRef WHEN T1._RecorderTRef = 0x00000062 THEN T18._Fld1433RRef ELSE CAST(NULL AS BINARY(16)) END,
T1._Fld3298_TYPE,
T1._Fld3298_RTRef,
T1._Fld3298_RRRef,
DATEADD(DAY,CAST(DATEPART(DAY,T1._Period) AS NUMERIC(4)) - 1,DATEADD(MONTH,CAST(DATEPART(MONTH,T1._Period) AS NUMERIC(4)) - 1,DATEADD(YEAR,(CAST(DATEPART(YEAR,T1._Period) AS NUMERIC(4)) - 2000) - 2000,{ts ''4000-01-01 00:00:00''}))),
T3._Fld1520RRef,
CASE WHEN T1._Fld3298_TYPE = 0x08 AND T1._Fld3298_RTRef = 0x00000033 THEN T19._Fld663RRef ELSE CAST(NULL AS BINARY(16)) END,
T1._Fld3303,
T1._Fld3302,
T3._Fld1537_TYPE,
T3._Fld1537_RTRef,
T3._Fld1537_RRRef,
@P1
FROM dbo._AccumRg3296 T1
INNER JOIN dbo._Document120_VT2094 T2
ON (T1._RecorderTRef = 0x00000078 AND T1._RecorderRRef = T2._Document120_IDRRef)
INNER JOIN dbo._Document99_VT1518 T3
ON (T2._Fld2096_TYPE = 0x08 AND T2._Fld2096_RTRef = 0x00000063 AND T2._Fld2096_RRRef = T3._Document99_IDRRef)
LEFT OUTER JOIN dbo._Document103 T4
ON (T1._RecorderTRef = 0x00000067 AND T1._RecorderRRef = T4._IDRRef) AND (T4._Fld4704 = @P2)
LEFT OUTER JOIN dbo._Document121 T5
ON (T1._RecorderTRef = 0x00000079 AND T1._RecorderRRef = T5._IDRRef) AND (T5._Fld4704 = @P3)
LEFT OUTER JOIN dbo._Document117 T6
ON (T1._RecorderTRef = 0x00000075 AND T1._RecorderRRef = T6._IDRRef) AND (T6._Fld4704 = @P4)
LEFT OUTER JOIN dbo._Document3895 T7
ON (T1._RecorderTRef = 0x00000F37 AND T1._RecorderRRef = T7._IDRRef) AND (T7._Fld4704 = @P5)
LEFT OUTER JOIN dbo._Document114 T8
ON (T1._RecorderTRef = 0x00000072 AND T1._RecorderRRef = T8._IDRRef) AND (T8._Fld4704 = @P6)
LEFT OUTER JOIN dbo._Document97 T9
ON (T1._RecorderTRef = 0x00000061 AND T1._RecorderRRef = T9._IDRRef) AND (T9._Fld4704 = @P7)
LEFT OUTER JOIN dbo._Document105X1 T10
ON (T1._RecorderTRef = 0x00000069 AND T1._RecorderRRef = T10._IDRRef) AND (T10._Fld4704 = @P8)
LEFT OUTER JOIN dbo._Document115X1 T11
ON (T1._RecorderTRef = 0x00000073 AND T1._RecorderRRef = T11._IDRRef) AND (T11._Fld4704 = @P9)
LEFT OUTER JOIN dbo._Document3946 T12
ON (T1._RecorderTRef = 0x00000F6A AND T1._RecorderRRef = T12._IDRRef) AND (T12._Fld4704 = @P10)
LEFT OUTER JOIN dbo._Document125X1 T13
ON (T1._RecorderTRef = 0x0000007D AND T1._RecorderRRef = T13._IDRRef) AND (T13._Fld4704 = @P11)
LEFT OUTER JOIN dbo._Document99 T14
ON (T1._RecorderTRef = 0x00000063 AND T1._RecorderRRef = T14._IDRRef) AND (T14._Fld4704 = @P12)
LEFT OUTER JOIN dbo._Document95 T15
ON (T1._RecorderTRef = 0x0000005F AND T1._RecorderRRef = T15._IDRRef) AND (T15._Fld4704 = @P13)
LEFT OUTER JOIN dbo._Document112 T16
ON (T1._RecorderTRef = 0x00000070 AND T1._RecorderRRef = T16._IDRRef) AND (T16._Fld4704 = @P14)
LEFT OUTER JOIN dbo._Document120 T17
ON (T1._RecorderTRef = 0x00000078 AND T1._RecorderRRef = T17._IDRRef) AND (T17._Fld4704 = @P15)
LEFT OUTER JOIN dbo._Document98 T18
ON (T1._RecorderTRef = 0x00000062 AND T1._RecorderRRef = T18._IDRRef) AND (T18._Fld4704 = @P16)
LEFT OUTER JOIN dbo._Reference51X1 T19
ON (T1._Fld3298_TYPE = 0x08 AND T1._Fld3298_RTRef = 0x00000033 AND T1._Fld3298_RRRef = T19._IDRRef) AND (T19._Fld4704 = @P17)
WHERE ((((T1._Fld4704 = @P18)) AND (T2._Fld4704 = @P19)) AND (T3._Fld4704 = @P20)) AND ((T1._Period >= @P21) AND (T1._Period <= @P22) AND (T1._RecordKind = @P23) AND (T1._Fld3299_TYPE = 0x08 AND T1._Fld3299_RTRef = 0x00000062))
GROUP BY CASE WHEN T1._RecorderTRef = 0x00000067 THEN T4._Fld1613RRef WHEN T1._RecorderTRef = 0x00000079 THEN T5._Fld2113RRef WHEN T1._RecorderTRef = 0x00000075 THEN T6._Fld1967RRef WHEN T1._RecorderTRef = 0x00000F37 THEN T7._Fld3897RRef WHEN T1._RecorderTRef = 0x00000072 THEN T8._Fld1871RRef WHEN T1._RecorderTRef = 0x00000061 THEN T9._Fld1411RRef WHEN T1._RecorderTRef = 0x00000069 THEN T10._Fld1648RRef WHEN T1._RecorderTRef = 0x00000073 THEN T11._Fld1909RRef WHEN T1._RecorderTRef = 0x00000F6A THEN T12._Fld3948RRef WHEN T1._RecorderTRef = 0x0000007D THEN T13._Fld2263RRef WHEN T1._RecorderTRef = 0x00000063 THEN T14._Fld1510RRef WHEN T1._RecorderTRef = 0x0000005F THEN T15._Fld1343RRef WHEN T1._RecorderTRef = 0x00000070 THEN T16._Fld1836RRef WHEN T1._RecorderTRef = 0x00000078 THEN T17._Fld2084RRef WHEN T1._RecorderTRef = 0x00000062 THEN T18._Fld1433RRef ELSE CAST(NULL AS BINARY(16)) END,
T1._Fld3298_TYPE,
T1._Fld3298_RTRef,
T1._Fld3298_RRRef,
DATEADD(DAY,CAST(DATEPART(DAY,T1._Period) AS NUMERIC(4)) - 1,DATEADD(MONTH,CAST(DATEPART(MONTH,T1._Period) AS NUMERIC(4)) - 1,DATEADD(YEAR,(CAST(DATEPART(YEAR,T1._Period) AS NUMERIC(4)) - 2000) - 2000,{ts ''4000-01-01 00:00:00''}))),
T3._Fld1520RRef,
T1._Fld3303,
T1._Fld3302,
CASE WHEN T1._Fld3298_TYPE = 0x08 AND T1._Fld3298_RTRef = 0x00000033 THEN T19._Fld663RRef ELSE CAST(NULL AS BINARY(16)) END,
T3._Fld1537_TYPE,
T3._Fld1537_RTRef,
T3._Fld1537_RRRef
HAVING (CAST(SUM(T1._Fld3302) AS NUMERIC(21, 3)) <> 0.0)',
N'@P1 nvarchar(4000),@P2 numeric(10),@P3 numeric(10),@P4 numeric(10),@P5 numeric(10),@P6 numeric(10),@P7 numeric(10),@P8 numeric(10),@P9 numeric(10),@P10 numeric(10),@P11 numeric(10),@P12 numeric(10),@P13 numeric(10),@P14 numeric(10),@P15 numeric(10),@P16 numeric(10),@P17 numeric(10),@P18 numeric(10),@P19 numeric(10),@P20 numeric(10),@P21 datetime2(3),@P22 datetime2(3),@P23 numeric(10)',
N'denso',0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,@DateStart,@DateEnd,0



-- ПродажиФакт
CREATE TABLE #tt270 (_Q_000_F_000RRef binary(16), _Q_000_F_001 NUMERIC(21, 3), _Q_000_F_002 NUMERIC(21, 3), 
_Q_000_F_003_TYPE binary(1), _Q_000_F_003_RTRef binary(16), _Q_000_F_003_RRRef binary(16), 
_Q_000_F_004RRef binary(16), _Q_000_F_005RRef binary(16), _Q_000_F_006 datetime, 
_Q_000_F_007 datetime, _Q_000_F_008 binary(1), _Q_000_F_009RRef binary(16), 
_Q_000_F_010_TYPE binary(1), _Q_000_F_010_RTRef binary(16), _Q_000_F_010_RRRef binary(16), _Q_000_F_011 nvarchar(10)) ;

exec sp_executesql N'INSERT INTO #tt270 WITH(TABLOCK) (_Q_000_F_000RRef, _Q_000_F_001, _Q_000_F_002, 
_Q_000_F_003_TYPE, _Q_000_F_003_RTRef, _Q_000_F_003_RRRef, 
_Q_000_F_004RRef, _Q_000_F_005RRef, _Q_000_F_006, 
_Q_000_F_007, _Q_000_F_008, _Q_000_F_009RRef, 
_Q_000_F_010_TYPE, _Q_000_F_010_RTRef, _Q_000_F_010_RRRef, _Q_000_F_011) 
SELECT
ISNULL(T2.Fld3226RRef,T7._Q_000_F_002RRef),
CASE WHEN (CAST(SUM(T6._Q_000_F_000) AS NUMERIC(27, 2)) = 0.0) THEN (CAST(CAST(SUM(T1._Q_000_F_001) AS NUMERIC(36, 4)) AS NUMERIC(38, 8)) / CAST(SUM(T6._Q_000_F_002) AS NUMERIC(27, 3))) ELSE ((CAST(CAST(SUM(T2.Fld3232_) AS NUMERIC(21, 2)) AS NUMERIC(14, 2)) * CAST(CAST(SUM(T1._Q_000_F_001) AS NUMERIC(36, 4)) AS NUMERIC(23, 4))) / CAST(SUM(T6._Q_000_F_000) AS NUMERIC(27, 2))) END,
CAST(SUM(T7._Q_000_F_001) AS NUMERIC(27, 3)),
CASE WHEN ISNULL(T2.Fld3224RRef,T7._Q_000_F_005RRef) IS NOT NULL THEN 0x08 END,
CASE WHEN ISNULL(T2.Fld3224RRef,T7._Q_000_F_005RRef) IS NOT NULL THEN 0x00000033 END,
ISNULL(T2.Fld3224RRef,T7._Q_000_F_005RRef),
ISNULL(T1._Q_000_F_002RRef,T7._Q_000_F_006RRef),
ISNULL(T2.Fld3225RRef,T7._Q_000_F_003RRef),
ISNULL(T1._Q_000_F_004,T7._Q_000_F_004),
ISNULL(T1._Q_000_F_005,T7._Q_000_F_007),
ISNULL(T1._Q_000_F_006,0x00),
ISNULL(T2.Fld4008RRef,T7._Q_000_F_008RRef),
CASE WHEN T2.Fld3229_TYPE IS NULL THEN T7._Q_000_F_009_TYPE ELSE T2.Fld3229_TYPE END,
CASE WHEN T2.Fld3229_TYPE IS NULL THEN T7._Q_000_F_009_RTRef ELSE T2.Fld3229_RTRef END,
CASE WHEN T2.Fld3229_TYPE IS NULL THEN T7._Q_000_F_009_RRRef ELSE T2.Fld3229_RRRef END,
@P1
FROM #tt266 T1 WITH(NOLOCK)
INNER JOIN (SELECT
T3._Fld4704 AS Fld4704_,
T3._Fld3226RRef AS Fld3226RRef,
T3._Fld4008RRef AS Fld4008RRef,
T3._Fld3222RRef AS Fld3222RRef,
T3._Fld3229_TYPE AS Fld3229_TYPE,
T3._Fld3229_RTRef AS Fld3229_RTRef,
T3._Fld3229_RRRef AS Fld3229_RRRef,
T3._RecorderTRef AS RecorderTRef,
T3._RecorderRRef AS RecorderRRef,
T3._Fld3224RRef AS Fld3224RRef,
T3._Fld3225RRef AS Fld3225RRef,
T3._Fld3232 AS Fld3232_
FROM dbo._AccumRg3221 T3
WHERE (T3._Fld4704 = @P2)) T2
LEFT OUTER JOIN (SELECT
T5._Description AS Description_,
T5._IDRRef AS IDRRef,
T5._Fld4704 AS Fld4704_
FROM dbo._Reference56X1 T5
WHERE (T5._Fld4704 = @P3)) T4
ON T2.Fld3226RRef = T4.IDRRef
ON (T1._Q_000_F_000_TYPE = 0x08 AND T1._Q_000_F_000_RTRef = T2.RecorderTRef AND T1._Q_000_F_000_RRRef = T2.RecorderRRef) AND (T4.Description_ <> @P4)
INNER JOIN #tt267 T6 WITH(NOLOCK)
ON (T2.RecorderTRef = T6._Q_000_F_001TRef AND T2.RecorderRRef = T6._Q_000_F_001RRef)
FULL OUTER JOIN #tt268 T7 WITH(NOLOCK)
ON (T1._Q_000_F_000_TYPE = 0x08 AND T1._Q_000_F_000_RTRef = T7._Q_000_F_000TRef AND T1._Q_000_F_000_RRRef = T7._Q_000_F_000RRef) AND (T1._Q_000_F_004 = T7._Q_000_F_004) AND (T2.Fld3226RRef = T7._Q_000_F_002RRef) AND (T2.Fld3225RRef = T7._Q_000_F_003RRef) AND (T2.Fld3229_TYPE = T7._Q_000_F_009_TYPE AND T2.Fld3229_RTRef = T7._Q_000_F_009_RTRef AND T2.Fld3229_RRRef = T7._Q_000_F_009_RRRef) AND (T2.Fld3222RRef = T7._Q_000_F_006RRef)
GROUP BY ISNULL(T2.Fld3226RRef,T7._Q_000_F_002RRef),
ISNULL(T1._Q_000_F_004,T7._Q_000_F_004),
ISNULL(T1._Q_000_F_002RRef,T7._Q_000_F_006RRef),
ISNULL(T2.Fld3225RRef,T7._Q_000_F_003RRef),
CASE WHEN ISNULL(T2.Fld3224RRef,T7._Q_000_F_005RRef) IS NOT NULL THEN 0x08 END,
CASE WHEN ISNULL(T2.Fld3224RRef,T7._Q_000_F_005RRef) IS NOT NULL THEN 0x00000033 END,
ISNULL(T2.Fld3224RRef,T7._Q_000_F_005RRef),
ISNULL(T1._Q_000_F_005,T7._Q_000_F_007),
ISNULL(T1._Q_000_F_006,0x00),
ISNULL(T2.Fld4008RRef,T7._Q_000_F_008RRef),
CASE WHEN T2.Fld3229_TYPE IS NULL THEN T7._Q_000_F_009_TYPE ELSE T2.Fld3229_TYPE END,
CASE WHEN T2.Fld3229_TYPE IS NULL THEN T7._Q_000_F_009_RTRef ELSE T2.Fld3229_RTRef END,
CASE WHEN T2.Fld3229_TYPE IS NULL THEN T7._Q_000_F_009_RRRef ELSE T2.Fld3229_RRRef END
UNION ALL SELECT
T8._Q_000_F_003RRef,
CAST(T8._Q_000_F_006 AS NUMERIC(38, 8)),
CAST(T8._Q_000_F_005 AS NUMERIC(27, 3)),
T8._Q_000_F_001_TYPE,
T8._Q_000_F_001_RTRef,
T8._Q_000_F_001_RRRef,
T8._Q_000_F_000RRef,
T8._Q_000_F_004RRef,
T8._Q_000_F_002,
DATEADD(DAY,CAST(DATEPART(DAY,T8._Q_000_F_002) AS NUMERIC(4)) - 1,DATEADD(MONTH,CAST(DATEPART(MONTH,T8._Q_000_F_002) AS NUMERIC(4)) - 1,DATEADD(YEAR,(CAST(DATEPART(YEAR,T8._Q_000_F_002) AS NUMERIC(4)) - 2000) - 2000,{ts ''4000-01-01 00:00:00''}))),
0x00,
CAST(NULL AS BINARY(16)),
T8._Q_000_F_007_TYPE,
T8._Q_000_F_007_RTRef,
T8._Q_000_F_007_RRRef,
@P5
FROM #tt269 T8 WITH(NOLOCK)
GROUP BY T8._Q_000_F_001_TYPE,
T8._Q_000_F_001_RTRef,
T8._Q_000_F_001_RRRef,
T8._Q_000_F_000RRef,
T8._Q_000_F_002,
T8._Q_000_F_004RRef,
T8._Q_000_F_003RRef,
CAST(T8._Q_000_F_005 AS NUMERIC(27, 3)),
CAST(T8._Q_000_F_006 AS NUMERIC(38, 8)),
DATEADD(DAY,CAST(DATEPART(DAY,T8._Q_000_F_002) AS NUMERIC(4)) - 1,DATEADD(MONTH,CAST(DATEPART(MONTH,T8._Q_000_F_002) AS NUMERIC(4)) - 1,DATEADD(YEAR,(CAST(DATEPART(YEAR,T8._Q_000_F_002) AS NUMERIC(4)) - 2000) - 2000,{ts ''4000-01-01 00:00:00''}))),
T8._Q_000_F_007_TYPE,
T8._Q_000_F_007_RTRef,
T8._Q_000_F_007_RRRef',N'@P1 nvarchar(4000),@P2 numeric(10),@P3 numeric(10),@P4 nvarchar(4000),@P5 nvarchar(4000)',N'denso',0,0,N'Карта сотрудника',N'denso'


-- СегментДопПлатежи
CREATE TABLE #tt271 (_Q_000_F_000_TYPE binary(1), _Q_000_F_000_RTRef binary(16), _Q_000_F_000_RRRef binary(16), _Q_000_F_001 nvarchar(10)); 
exec sp_executesql N'INSERT INTO #tt271 WITH(TABLOCK) (_Q_000_F_000_TYPE, _Q_000_F_000_RTRef, _Q_000_F_000_RRRef, _Q_000_F_001) SELECT
T2._Fld2979_TYPE,
T2._Fld2979_RTRef,
T2._Fld2979_RRRef,
@P1
FROM dbo._Reference68 T1
INNER JOIN dbo._InfoRg2977 T2
ON (0x08 = T2._Fld2978_TYPE AND 0x00000044 = T2._Fld2978_RTRef AND T1._IDRRef = T2._Fld2978_RRRef)
WHERE (((T1._Fld4704 = @P2)) AND (T2._Fld4704 = @P3)) AND ((T1._Description = @P4))',N'@P1 nvarchar(4000),@P2 numeric(10),@P3 numeric(10),@P4 nvarchar(4000)',N'denso',0,0,N'ДОП. платежи'

-- СегментРекайринг
CREATE TABLE #tt272 (_Q_000_F_000_TYPE binary(1), _Q_000_F_000_RTRef binary(16), _Q_000_F_000_RRRef binary(16), _Q_000_F_001 nvarchar(10)); 
exec sp_executesql N'INSERT INTO #tt272 WITH(TABLOCK) (_Q_000_F_000_TYPE, _Q_000_F_000_RTRef, _Q_000_F_000_RRRef, _Q_000_F_001) SELECT
T2._Fld2979_TYPE,
T2._Fld2979_RTRef,
T2._Fld2979_RRRef,
@P1
FROM dbo._Reference68 T1
INNER JOIN dbo._InfoRg2977 T2
ON (0x08 = T2._Fld2978_TYPE AND 0x00000044 = T2._Fld2978_RTRef AND T1._IDRRef = T2._Fld2978_RRRef)
WHERE (((T1._Fld4704 = @P2)) AND (T2._Fld4704 = @P3)) AND ((T1._Description = @P4))',N'@P1 nvarchar(4000),@P2 numeric(10),@P3 numeric(10),@P4 nvarchar(4000)',N'denso',0,0,N'Рекайринг'


-- СегментСертификаты
CREATE TABLE #tt273 (_Q_000_F_000_TYPE binary(1), _Q_000_F_000_RTRef binary(16), _Q_000_F_000_RRRef binary(16), _Q_000_F_001 nvarchar(10)); 
exec sp_executesql N'INSERT INTO #tt273 WITH(TABLOCK) (_Q_000_F_000_TYPE, _Q_000_F_000_RTRef, _Q_000_F_000_RRRef, _Q_000_F_001) SELECT
T2._Fld2979_TYPE,
T2._Fld2979_RTRef,
T2._Fld2979_RRRef,
@P1
FROM dbo._Reference68 T1
INNER JOIN dbo._InfoRg2977 T2
ON (0x08 = T2._Fld2978_TYPE AND 0x00000044 = T2._Fld2978_RTRef AND T1._IDRRef = T2._Fld2978_RRRef)
WHERE (((T1._Fld4704 = @P2)) AND (T2._Fld4704 = @P3)) AND ((T1._Description = @P4))',N'@P1 nvarchar(4000),@P2 numeric(10),@P3 numeric(10),@P4 nvarchar(4000)',N'denso',0,0,N'Сертификаты'


-- СегментСертификаты
CREATE TABLE #tt274 (_Q_000_F_000_TYPE binary(1), _Q_000_F_000_RTRef binary(16), _Q_000_F_000_RRRef binary(16), _Q_000_F_001 nvarchar(10)); 
exec sp_executesql N'INSERT INTO #tt274 WITH(TABLOCK) (_Q_000_F_000_TYPE, _Q_000_F_000_RTRef, _Q_000_F_000_RRRef, _Q_000_F_001) SELECT
T2._Fld2979_TYPE,
T2._Fld2979_RTRef,
T2._Fld2979_RRRef,
@P1
FROM dbo._Reference68 T1
INNER JOIN dbo._InfoRg2977 T2
ON (0x08 = T2._Fld2978_TYPE AND 0x00000044 = T2._Fld2978_RTRef AND T1._IDRRef = T2._Fld2978_RRRef)
WHERE (((T1._Fld4704 = @P2)) AND (T2._Fld4704 = @P3)) AND ((T1._Description = @P4) AND (T1._Folder) = 0x01)',N'@P1 nvarchar(4000),@P2 numeric(10),@P3 numeric(10),@P4 nvarchar(4000)',N'denso',0,0,N'СЕКЦИИ'



-- Итог
CREATE TABLE #tt275 (SalesCardType nvarchar(10), ItemID binary(16), Quantity NUMERIC(21, 3), 
Amount NUMERIC(21, 3), _Q_000_F_004_TYPE binary(1), _Q_000_F_004_RTRef binary(16), 
ClientID binary(16), ClubID binary(16), _Q_000_F_006_TYPE binary(1), 
_Q_000_F_006_L binary(1), _Q_000_F_006_S nvarchar(100), ManagerID binary(16), 
[Date] datetime, [DateOfSale] datetime, _Q_000_F_009 binary(1), 
_Q_000_F_010RRef binary(16), _Q_000_F_011_TYPE binary(1), _Q_000_F_011_RTRef binary(16), 
MembershipID binary(16), ExtensionTypeID binary(16), _Q_000_F_013 nvarchar(10)); 
exec sp_executesql N'
INSERT INTO #tt275 WITH(TABLOCK) (SalesCardType, ItemID, Quantity, Amount, _Q_000_F_004_TYPE, _Q_000_F_004_RTRef, ClientID, ClubID, _Q_000_F_006_TYPE, _Q_000_F_006_L, _Q_000_F_006_S, ManagerID, [Date], [DateOfSale], _Q_000_F_009, _Q_000_F_010RRef, _Q_000_F_011_TYPE, _Q_000_F_011_RTRef, MembershipID, ExtensionTypeID, _Q_000_F_013)

SELECT
CASE WHEN (T2._Q_000_F_000_TYPE IS NOT NULL AND T2._Q_000_F_000_RTRef IS NOT NULL AND T2._Q_000_F_000_RRRef IS NOT NULL) THEN @P1 WHEN (T3._Q_000_F_000_TYPE IS NOT NULL AND T3._Q_000_F_000_RTRef IS NOT NULL AND T3._Q_000_F_000_RRRef IS NOT NULL) OR (T5._Q_000_F_000_TYPE IS NOT NULL AND T5._Q_000_F_000_RTRef IS NOT NULL AND T5._Q_000_F_000_RRRef IS NOT NULL) THEN @P2 WHEN (T4._Q_000_F_000_TYPE IS NOT NULL AND T4._Q_000_F_000_RTRef IS NOT NULL AND T4._Q_000_F_000_RRRef IS NOT NULL) THEN @P3 ELSE @P4 END,
T1._Q_000_F_000RRef,
CASE WHEN (T3._Q_000_F_000_TYPE IS NOT NULL AND T3._Q_000_F_000_RTRef IS NOT NULL AND T3._Q_000_F_000_RRRef IS NOT NULL) OR (T5._Q_000_F_000_TYPE IS NOT NULL AND T5._Q_000_F_000_RTRef IS NOT NULL AND T5._Q_000_F_000_RRRef IS NOT NULL) THEN @P5 ELSE T1._Q_000_F_002 END,
CASE WHEN (T4._Q_000_F_000_TYPE IS NOT NULL AND T4._Q_000_F_000_RTRef IS NOT NULL AND T4._Q_000_F_000_RRRef IS NOT NULL) THEN @P6 ELSE T1._Q_000_F_001 END,
T1._Q_000_F_003_TYPE,
T1._Q_000_F_003_RTRef,
T1._Q_000_F_003_RRRef,
T1._Q_000_F_004RRef,
CASE WHEN (T4._Q_000_F_000_TYPE IS NOT NULL AND T4._Q_000_F_000_RTRef IS NOT NULL AND T4._Q_000_F_000_RRRef IS NOT NULL) OR (T5._Q_000_F_000_TYPE IS NOT NULL AND T5._Q_000_F_000_RTRef IS NOT NULL AND T5._Q_000_F_000_RRRef IS NOT NULL) THEN CASE WHEN T1._Q_000_F_005RRef IS NOT NULL THEN 0x08 END WHEN T1._Q_000_F_008 = 0x01 THEN CASE WHEN T6._Fld6439_TYPE IS NULL THEN 0x05 ELSE T6._Fld6439_TYPE END WHEN (T1._Q_000_F_006 >= @P7) THEN CASE WHEN T1._Q_000_F_005RRef IS NOT NULL THEN 0x08 END WHEN (CASE WHEN T1._Q_000_F_003_TYPE = 0x08 AND T1._Q_000_F_003_RTRef = 0x00000033 THEN T7._Fld663RRef ELSE CAST(NULL AS BINARY(16)) END = @P8) THEN 0x05 ELSE CASE WHEN CASE WHEN T1._Q_000_F_003_TYPE = 0x08 AND T1._Q_000_F_003_RTRef = 0x00000033 THEN T7._Fld663RRef ELSE CAST(NULL AS BINARY(16)) END IS NOT NULL THEN 0x08 END END,
CASE WHEN (T4._Q_000_F_000_TYPE IS NOT NULL AND T4._Q_000_F_000_RTRef IS NOT NULL AND T4._Q_000_F_000_RRRef IS NOT NULL) OR (T5._Q_000_F_000_TYPE IS NOT NULL AND T5._Q_000_F_000_RTRef IS NOT NULL AND T5._Q_000_F_000_RRRef IS NOT NULL) THEN CASE WHEN T1._Q_000_F_005RRef IS NOT NULL THEN 0x00 END WHEN T1._Q_000_F_008 = 0x01 THEN CASE WHEN T6._Fld6439_TYPE IS NULL THEN 0x00 ELSE T6._Fld6439_L END WHEN (T1._Q_000_F_006 >= @P9) THEN CASE WHEN T1._Q_000_F_005RRef IS NOT NULL THEN 0x00 END WHEN (CASE WHEN T1._Q_000_F_003_TYPE = 0x08 AND T1._Q_000_F_003_RTRef = 0x00000033 THEN T7._Fld663RRef ELSE CAST(NULL AS BINARY(16)) END = @P10) THEN 0x00 ELSE CASE WHEN CASE WHEN T1._Q_000_F_003_TYPE = 0x08 AND T1._Q_000_F_003_RTRef = 0x00000033 THEN T7._Fld663RRef ELSE CAST(NULL AS BINARY(16)) END IS NOT NULL THEN 0x00 END END,
CASE WHEN (T4._Q_000_F_000_TYPE IS NOT NULL AND T4._Q_000_F_000_RTRef IS NOT NULL AND T4._Q_000_F_000_RRRef IS NOT NULL) OR (T5._Q_000_F_000_TYPE IS NOT NULL AND T5._Q_000_F_000_RTRef IS NOT NULL AND T5._Q_000_F_000_RRRef IS NOT NULL) THEN CASE WHEN T1._Q_000_F_005RRef IS NOT NULL THEN @P11 END WHEN T1._Q_000_F_008 = 0x01 THEN CASE WHEN T6._Fld6439_TYPE IS NULL THEN @P12 ELSE CASE WHEN T6._Fld6439_TYPE IS NOT NULL THEN @P13 END END WHEN (T1._Q_000_F_006 >= @P14) THEN CASE WHEN T1._Q_000_F_005RRef IS NOT NULL THEN @P15 END WHEN (CASE WHEN T1._Q_000_F_003_TYPE = 0x08 AND T1._Q_000_F_003_RTRef = 0x00000033 THEN T7._Fld663RRef ELSE CAST(NULL AS BINARY(16)) END = @P16) THEN @P17 ELSE CASE WHEN CASE WHEN T1._Q_000_F_003_TYPE = 0x08 AND T1._Q_000_F_003_RTRef = 0x00000033 THEN T7._Fld663RRef ELSE CAST(NULL AS BINARY(16)) END IS NOT NULL THEN @P18 END END,
CASE WHEN (T4._Q_000_F_000_TYPE IS NOT NULL AND T4._Q_000_F_000_RTRef IS NOT NULL AND T4._Q_000_F_000_RRRef IS NOT NULL) OR (T5._Q_000_F_000_TYPE IS NOT NULL AND T5._Q_000_F_000_RTRef IS NOT NULL AND T5._Q_000_F_000_RRRef IS NOT NULL) THEN T1._Q_000_F_005RRef WHEN T1._Q_000_F_008 = 0x01 THEN CASE WHEN T6._Fld6439_TYPE IS NULL THEN @P19 ELSE T6._Fld6439_RRRef END WHEN (T1._Q_000_F_006 >= @P20) THEN T1._Q_000_F_005RRef WHEN (CASE WHEN T1._Q_000_F_003_TYPE = 0x08 AND T1._Q_000_F_003_RTRef = 0x00000033 THEN T7._Fld663RRef ELSE CAST(NULL AS BINARY(16)) END = @P21) THEN @P22 ELSE CASE WHEN T1._Q_000_F_003_TYPE = 0x08 AND T1._Q_000_F_003_RTRef = 0x00000033 THEN T7._Fld663RRef ELSE CAST(NULL AS BINARY(16)) END END,
T1._Q_000_F_006,
T1._Q_000_F_007,
0x00,
T1._Q_000_F_009RRef,
T1._Q_000_F_010_TYPE,
T1._Q_000_F_010_RTRef,
T1._Q_000_F_010_RRRef,
CASE WHEN (CASE WHEN T1._Q_000_F_010_TYPE = 0x08 AND T1._Q_000_F_010_RTRef = 0x0000007D THEN T8._Fld2267RRef ELSE CAST(NULL AS BINARY(16)) END = @P23) THEN @P24 ELSE CASE WHEN T1._Q_000_F_010_TYPE = 0x08 AND T1._Q_000_F_010_RTRef = 0x0000007D THEN T8._Fld2267RRef ELSE CAST(NULL AS BINARY(16)) END END,
@P25
FROM #tt270 T1 WITH(NOLOCK)
LEFT OUTER JOIN #tt272 T2 WITH(NOLOCK)
ON (CASE WHEN T1._Q_000_F_000RRef IS NOT NULL THEN 0x08 END = T2._Q_000_F_000_TYPE AND CASE WHEN T1._Q_000_F_000RRef IS NOT NULL THEN 0x00000038 END = T2._Q_000_F_000_RTRef AND T1._Q_000_F_000RRef = T2._Q_000_F_000_RRRef)
LEFT OUTER JOIN #tt271 T3 WITH(NOLOCK)
ON (CASE WHEN T1._Q_000_F_000RRef IS NOT NULL THEN 0x08 END = T3._Q_000_F_000_TYPE AND CASE WHEN T1._Q_000_F_000RRef IS NOT NULL THEN 0x00000038 END = T3._Q_000_F_000_RTRef AND T1._Q_000_F_000RRef = T3._Q_000_F_000_RRRef)
LEFT OUTER JOIN #tt274 T4 WITH(NOLOCK)
ON (CASE WHEN T1._Q_000_F_000RRef IS NOT NULL THEN 0x08 END = T4._Q_000_F_000_TYPE AND CASE WHEN T1._Q_000_F_000RRef IS NOT NULL THEN 0x00000038 END = T4._Q_000_F_000_RTRef AND T1._Q_000_F_000RRef = T4._Q_000_F_000_RRRef)
LEFT OUTER JOIN #tt273 T5 WITH(NOLOCK)
ON (CASE WHEN T1._Q_000_F_000RRef IS NOT NULL THEN 0x08 END = T5._Q_000_F_000_TYPE AND CASE WHEN T1._Q_000_F_000RRef IS NOT NULL THEN 0x00000038 END = T5._Q_000_F_000_RTRef AND T1._Q_000_F_000RRef = T5._Q_000_F_000_RRRef)
LEFT OUTER JOIN dbo._InfoRg6435X1 T6
ON (T1._Q_000_F_004RRef = T6._Fld6436RRef) AND (T1._Q_000_F_003_TYPE = CASE WHEN T6._Fld6437RRef IS NOT NULL THEN 0x08 END AND T1._Q_000_F_003_RTRef = CASE WHEN T6._Fld6437RRef IS NOT NULL THEN 0x00000033 END AND T1._Q_000_F_003_RRRef = T6._Fld6437RRef) AND (T6._Fld6438 = @P26)
LEFT OUTER JOIN dbo._Reference51X1 T7
ON (T1._Q_000_F_003_TYPE = 0x08 AND T1._Q_000_F_003_RTRef = 0x00000033 AND T1._Q_000_F_003_RRRef = T7._IDRRef) AND (T7._Fld4704 = @P27)
LEFT OUTER JOIN dbo._Document125X1 T8
ON (T1._Q_000_F_010_TYPE = 0x08 AND T1._Q_000_F_010_RTRef = 0x0000007D AND T1._Q_000_F_010_RRRef = T8._IDRRef) AND (T8._Fld4704 = @P28)
LEFT OUTER JOIN dbo._Reference56X1 T9
ON (T1._Q_000_F_000RRef = T9._IDRRef) AND (T9._Fld4704 = @P29)
LEFT OUTER JOIN dbo._Reference73X1 T10
ON (T1._Q_000_F_005RRef = T10._IDRRef) AND (T10._Fld4704 = @P30)
LEFT OUTER JOIN dbo._Reference40X1 T11
ON (T10._Fld1083RRef = T11._IDRRef) AND (T11._Fld4704 = @P31)
WHERE ((T2._Q_000_F_000_TYPE IS NOT NULL AND T2._Q_000_F_000_RTRef IS NOT NULL AND T2._Q_000_F_000_RRRef IS NOT NULL) OR (T3._Q_000_F_000_TYPE IS NOT NULL AND T3._Q_000_F_000_RTRef IS NOT NULL AND T3._Q_000_F_000_RRRef IS NOT NULL) OR (T4._Q_000_F_000_TYPE IS NOT NULL AND T4._Q_000_F_000_RTRef IS NOT NULL AND T4._Q_000_F_000_RRRef IS NOT NULL) OR (T5._Q_000_F_000_TYPE IS NOT NULL AND T5._Q_000_F_000_RTRef IS NOT NULL AND T5._Q_000_F_000_RRRef IS NOT NULL) OR (T9._Fld833RRef = @P32)) AND CASE WHEN (T4._Q_000_F_000_TYPE IS NOT NULL AND T4._Q_000_F_000_RTRef IS NOT NULL AND T4._Q_000_F_000_RRRef IS NOT NULL) THEN CASE WHEN (T11._Code = @P33) THEN 0x01 WHEN NOT (T11._Code = @P34) THEN 0x00 END ELSE 0x01 END = 0x01
order by 4 desc',
N'@P1 nvarchar(4000),@P2 nvarchar(4000),@P3 nvarchar(4000),@P4 nvarchar(4000),@P5 numeric(10),@P6 numeric(10),@P7 datetime2(3),@P8 varbinary(16),@P9 datetime2(3),@P10 varbinary(16),@P11 nvarchar(4000),@P12 nvarchar(4000),@P13 nvarchar(4000),@P14 datetime2(3),@P15 nvarchar(4000),@P16 varbinary(16),@P17 nvarchar(4000),@P18 nvarchar(4000),@P19 varbinary(16),@P20 datetime2(3),@P21 varbinary(16),@P22 varbinary(16),@P23 varbinary(16),@P24 varbinary(16),@P25 nvarchar(4000),@P26 nvarchar(4000),@P27 numeric(10),@P28 numeric(10),@P29 numeric(10),@P30 numeric(10),@P31 numeric(10),@P32 varbinary(16),@P33 nvarchar(4000),@P34 nvarchar(4000)',N'Рекайринг',N'Допы',
N'Секции',N'Карты',0,0,'4021-03-01 00:00:00',0x00000000000000000000000000000000,'4021-03-01 00:00:00',0x00000000000000000000000000000000,N'',N'Не распределено',N'','4021-03-01 00:00:00',
N'',0x00000000000000000000000000000000,N'Не распределено',N'',0x00000000000000000000000000000000,'4021-03-01 00:00:00',
0x00000000000000000000000000000000,0x00000000000000000000000000000000,0x8D8B5E6AA8DD088B41C988260885C4D9,0xA5058B6CC78D22764475F86F541F31B0,
N'denso',N'СотрудникВездеход',0,0,0,0,0,0xBF3C881733694B8F462E8D8B9E26692F,N'000000001',N'000000001'


--Заполнение таблицы фактов
delete
from	[DWH].dbo.CardSales
where	[Date] between dateadd(year,-2000,@DateStart) and dateadd(year,-2000,@DateEnd)

insert into [DWH].dbo.CardSales([Date]
      ,[ItemID]
      ,[ClientID]
      ,[ClubID]
      ,[ManagerID]
      ,[MembershipID]
      ,[ExtensionTypeID]
      ,[Quantity]
      ,[Amount])
select	dateadd(year,-2000,t.[Date]),
		sys.fn_varbintohexstr(t.ItemID),
		sys.fn_varbintohexstr(t.ClientID),
		sys.fn_varbintohexstr(t.ClubID),
		sys.fn_varbintohexstr(t.ManagerID),
		sys.fn_varbintohexstr(t.MembershipID),
		isnull(sys.fn_varbintohexstr(t.ExtensionTypeID),'0'),
		sum(t.Quantity),
		sum(t.Amount)
from	#tt275 t
group by
		dateadd(year,-2000,t.[Date]),
		sys.fn_varbintohexstr(t.ItemID),
		sys.fn_varbintohexstr(t.ClientID),
		sys.fn_varbintohexstr(t.ClubID),
		sys.fn_varbintohexstr(t.ManagerID),
		sys.fn_varbintohexstr(t.MembershipID),
		sys.fn_varbintohexstr(t.ExtensionTypeID)


--Заполнение длительности членств
SELECT 	sys.fn_varbintohexstr(T1._IDRRef) _IDRRef,
		CASE WHEN (T1._Fld866RRef = 0x9DB2E0BCE7CAEB9742C61D727D713F0B) THEN T1._Fld864 WHEN (T1._Fld866RRef = 0x8D515B434DD02AE34A462E7456D630BD) THEN (CAST(T1._Fld864 AS NUMERIC(18, 8)) / 30) END as Months,
		CASE WHEN (T1._Fld866RRef = 0x9DB2E0BCE7CAEB9742C61D727D713F0B) THEN (T1._Fld864 * 30) WHEN (T1._Fld866RRef = 0x8D515B434DD02AE34A462E7456D630BD) THEN T1._Fld864 END as Days
INTO	#Items
FROM	dbo._Reference56X1 T1
WHERE	(T1._Fld4704 = 0)
		and sys.fn_varbintohexstr(T1._IDRRef) in (select distinct [ItemID] from	DWH.[dbo].[CardSales])


update	dwh.[dbo].[CardSales]
set		dwh.[dbo].[CardSales].[DurationMonth]=item.Months,
		dwh.[dbo].[CardSales].[DurationDays]=item.Days
from	dwh.[dbo].[CardSales] fact
		join
		#Items item on fact.ItemID=item._IDRRef
where	[Date] between dateadd(year,-2000,@DateStart) and dateadd(year,-2000,@DateEnd)

drop table #Items



--группировка мелких продажников в Остальное
SELECT	[ManagerID],
		[ClubID]
into	#OstManagers
FROM [DWH].[dbo].[CardSales] 
where	[Date] between DATEADD(month, DATEDIFF(month, 0, dateadd(year,-2000,@DateStart)), 0) and DATEADD(month, DATEDIFF(month, 0, dateadd(year,-2000,@DateEnd))+1, 0) -1
group by
		month([Date]),
		year([Date]),
		[ManagerID],
		[ClubID]
having	sum(isnull([Amount],0))<1000



update	[DWH].[dbo].[CardSales]
set		[ManagerID]='0'
from	[DWH].[dbo].[CardSales] t1
		join
		#OstManagers t2 on t1.ManagerID=t2.ManagerID and t1.ClubID=t2.ClubID
where	[Date] between DATEADD(month, DATEDIFF(month, 0, dateadd(year,-2000,@DateStart)), 0) and DATEADD(month, DATEDIFF(month, 0, dateadd(year,-2000,@DateEnd))+1, 0) -1


drop table #OstManagers


--Заполнение посещений
exec sp_executesql N'SELECT
DATEADD(DAY,CAST(DATEPART(DAY,T1._Date_Time) AS NUMERIC(4)) - 1,DATEADD(MONTH,CAST(DATEPART(MONTH,T1._Date_Time) AS NUMERIC(4)) - 1,DATEADD(YEAR,(CAST(DATEPART(YEAR,T1._Date_Time) AS NUMERIC(4)) - 2000) - 2000,{ts ''4000-01-01 00:00:00''}))) [Date],
T1._Fld3897RRef,
CAST(COUNT(DISTINCT T1._IDRRef) AS NUMERIC(12)) [Quantity]
into ##DensoVisitors
FROM dbo._Document3895 T1
WHERE ((T1._Fld4704 = @P2)) AND (T1._Posted = 0x01 AND (T1._Date_Time >= @P3) AND (T1._Date_Time <= @P4))
GROUP BY T1._Fld3897RRef,
DATEADD(DAY,CAST(DATEPART(DAY,T1._Date_Time) AS NUMERIC(4)) - 1,DATEADD(MONTH,CAST(DATEPART(MONTH,T1._Date_Time) AS NUMERIC(4)) - 1,DATEADD(YEAR,(CAST(DATEPART(YEAR,T1._Date_Time) AS NUMERIC(4)) - 2000) - 2000,{ts ''4000-01-01 00:00:00''})))'
,N'@P1 nvarchar(4000),@P2 numeric(10),@P3 datetime2(3),@P4 datetime2(3)',N'denso',0,@DateStart,@DateEnd



delete	
from	dwh.[dbo].[Visitors]
where	[Date] between dateadd(year,-2000,@DateStart) and dateadd(year,-2000,@DateEnd)


insert into dwh.[dbo].[Visitors]
	([Date]
      ,[ClubID]
      ,[Quantity])
select	dateadd(year,-2000,[Date]),
		sys.fn_varbintohexstr(_Fld3897RRef),
		[Quantity]
from	##DensoVisitors


drop table ##DensoVisitors




--удаление временных таблиц
drop table #tt262
drop table #tt263
drop table #tt264
drop table #tt265
drop table #tt266
drop table #tt267
drop table #tt268
drop table #tt269
drop table #tt270
drop table #tt271
drop table #tt272
drop table #tt273
drop table #tt274
drop table #tt275


END
GO
