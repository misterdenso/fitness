-- Create a new stored procedure called 'StoredProcedureName' in schema 'SchemaName'
-- Drop the stored procedure if it already exists
IF EXISTS (
SELECT *
    FROM INFORMATION_SCHEMA.ROUTINES
WHERE SPECIFIC_SCHEMA = N'dbo'
    AND SPECIFIC_NAME = N'UpdatePercent'
)
DROP PROCEDURE dbo.UpdatePercent
GO
-- Create the stored procedure in the specified schema
CREATE PROCEDURE dbo.UpdatePercent
    @DateStart datetime2(3),
	@DateEnd datetime2(3)
AS


declare 	@DateStart10 datetime2(3),
            @DateStart3mon datetime2(3)

    
select	@DateStart = dateadd(year,2000,@DateStart),
		@DateEnd = dateadd(year,2000,@DateEnd)



select  @DateStart10 = dateadd(DAY, - 10, @DateStart),
        @DateStart3mon = dateadd(MONTH, -3, @DateStart)

 

--СегментИсключение
exec sp_executesql N'--INSERT INTO #tt375 WITH(TABLOCK) (_Q_000_F_000_TYPE, _Q_000_F_000_RTRef, _Q_000_F_000_RRRef, _Q_000_F_001) 
SELECT
T1._Fld2979_TYPE _Q_000_F_000_TYPE,
T1._Fld2979_RTRef _Q_000_F_000_RTRef,
T1._Fld2979_RRRef _Q_000_F_000_RRRef,
@P1 _Q_000_F_001
into ##tt375
FROM dbo._InfoRg2977 T1
WHERE ((T1._Fld4704 = @P2)) AND ((T1._Fld2978_TYPE = 0x08 AND T1._Fld2978_RTRef = 0x00000044 AND T1._Fld2978_RRRef = @P3))',
N'@P1 nvarchar(4000),@P2 numeric(10),@P3 varbinary(16)',N'denso',0,0x812E00155D59960211E9B210C0F3382A


--ТекущиеЧленыКлуба
exec sp_executesql N'--INSERT INTO #tt376 WITH(TABLOCK) (_Q_000_F_000RRef, _Q_000_F_001RRef, _Q_000_F_002) 
SELECT
T1.Fld3017RRef _Q_000_F_000RRef,
T1.Fld3018RRef _Q_000_F_001RRef,
@P1 _Q_000_F_002
into ##tt376
FROM (SELECT
T4._Fld3018RRef AS Fld3018RRef,
T4._Fld3017RRef AS Fld3017RRef
FROM (SELECT
T3._Fld3017RRef AS Fld3017RRef,
MAX(T3._Period) AS MAXPERIOD_
FROM dbo._InfoRg3016 T3
WHERE ((T3._Fld4704 = @P2)) AND (T3._Period <= @P3)
GROUP BY T3._Fld3017RRef) T2
INNER JOIN dbo._InfoRg3016 T4
ON T2.Fld3017RRef = T4._Fld3017RRef AND T2.MAXPERIOD_ = T4._Period
WHERE (T4._Fld4704 = @P4)) T1
WHERE (T1.Fld3018RRef = @P5)',N'@P1 nvarchar(4000),@P2 numeric(10),@P3 datetime2(3),@P4 numeric(10),@P5 varbinary(16)',
N'denso',0,@DateEnd,0,0x8028BF54E6F1BB8244747ACFB274D020


--ЗакончилисьВТек
exec sp_executesql N'--INSERT INTO #tt377 WITH(TABLOCK) (_Q_000_F_000, _Q_000_F_001_TYPE, _Q_000_F_001_RTRef, _Q_000_F_001_RRRef, 
--_Q_000_F_002RRef, _Q_000_F_003, _Q_000_F_004) 
SELECT
MAX(DATEADD(SECOND,-1.0,T1._Fld3075)) _Q_000_F_000,
T2._Fld2250_TYPE _Q_000_F_001_TYPE,
T2._Fld2250_RTRef _Q_000_F_001_RTRef,
T2._Fld2250_RRRef _Q_000_F_001_RRRef,
T2._Fld2263RRef _Q_000_F_002RRef,
MAX(CASE WHEN (NOT (((T4._Fld2978_TYPE IS NULL AND T4._Fld2978_RTRef IS NULL AND T4._Fld2978_RRRef IS NULL)))) THEN 0x01 ELSE 0x00 END) _Q_000_F_003,
@P1 _Q_000_F_004
into ##tt377
FROM dbo._InfoRg3071 T1
LEFT OUTER JOIN dbo._Document125X1 T2
ON (T1._Fld3072RRef = T2._IDRRef) AND (T2._Fld4704 = @P2)
LEFT OUTER JOIN ##tt375 T3 WITH(NOLOCK)
ON (0x08 = T3._Q_000_F_000_TYPE AND 0x00000038 = T3._Q_000_F_000_RTRef AND T2._Fld2251RRef = T3._Q_000_F_000_RRRef)
LEFT OUTER JOIN dbo._InfoRg2977 T4
ON ((0x08 = T4._Fld2979_TYPE AND 0x00000038 = T4._Fld2979_RTRef AND T2._Fld2251RRef = T4._Fld2979_RRRef) AND (T4._Fld2978_TYPE = 0x08 
AND T4._Fld2978_RTRef = 0x00000044 AND T4._Fld2978_RRRef = @P3)) AND (T4._Fld4704 = @P4)
WHERE ((T1._Fld4704 = @P5)) AND ((DATEADD(SECOND,-@P6,T1._Fld3075) >= @P7) AND (DATEADD(SECOND,-@P8,T1._Fld3075) <= @P9) 
AND (T2._Fld2264RRef = @P10) AND T2._Posted = 0x01 AND (T3._Q_000_F_000_TYPE IS NULL AND T3._Q_000_F_000_RTRef IS NULL 
AND T3._Q_000_F_000_RRRef IS NULL))
GROUP BY T2._Fld2250_TYPE,
T2._Fld2250_RTRef,
T2._Fld2250_RRRef,
T2._Fld2263RRef',N'@P1 nvarchar(4000),@P2 numeric(10),@P3 varbinary(16),@P4 numeric(10),@P5 numeric(10),@P6 numeric(10),
@P7 datetime2(3),@P8 numeric(10),@P9 datetime2(3),@P10 varbinary(16)',
N'denso',0,0x811300155D59960211E8E41D1AB55C19,0,0,1,@DateStart,1,@DateEnd,0xBF3C881733694B8F462E8D8B9E26692F


--ЗакончилисьПред10Дней
exec sp_executesql N'--INSERT INTO #tt378 WITH(TABLOCK) (_Q_000_F_000, _Q_000_F_001_TYPE, _Q_000_F_001_RTRef, _Q_000_F_001_RRRef, _Q_000_F_002RRef, _Q_000_F_003) 
SELECT
MAX(DATEADD(SECOND,-1.0,T1._Fld3075)) _Q_000_F_000,
T2._Fld2250_TYPE _Q_000_F_001_TYPE,
T2._Fld2250_RTRef _Q_000_F_001_RTRef,
T2._Fld2250_RRRef _Q_000_F_001_RRRef,
T2._Fld2263RRef _Q_000_F_002RRef,
@P1 _Q_000_F_003
into ##tt378
FROM dbo._InfoRg3071 T1
LEFT OUTER JOIN dbo._Document125X1 T2
ON (T1._Fld3072RRef = T2._IDRRef) AND (T2._Fld4704 = @P2)
LEFT OUTER JOIN ##tt375 T3 WITH(NOLOCK)
ON (0x08 = T3._Q_000_F_000_TYPE AND 0x00000038 = T3._Q_000_F_000_RTRef AND T2._Fld2251RRef = T3._Q_000_F_000_RRRef)
WHERE ((T1._Fld4704 = @P3)) AND ((DATEADD(SECOND,-@P4,T1._Fld3075) >= @P5) AND (DATEADD(SECOND,-@P6,T1._Fld3075) < @P7) AND (T2._Fld2264RRef = @P8) AND T2._Posted = 0x01 AND (T3._Q_000_F_000_TYPE IS NULL AND T3._Q_000_F_000_RTRef IS NULL AND T3._Q_000_F_000_RRRef IS NULL))
GROUP BY T2._Fld2250_TYPE,
T2._Fld2250_RTRef,
T2._Fld2250_RRRef,
T2._Fld2263RRef',N'@P1 nvarchar(4000),@P2 numeric(10),@P3 numeric(10),@P4 numeric(10),@P5 datetime2(3),@P6 numeric(10),@P7 datetime2(3),@P8 varbinary(16)',
N'denso',0,0,1,@DateStart10,1,@DateStart,0xBF3C881733694B8F462E8D8B9E26692F


--КупилиВТек
exec sp_executesql N'--INSERT INTO #tt379 WITH(TABLOCK) (_Q_000_F_000_TYPE, _Q_000_F_000_RTRef, _Q_000_F_000_RRRef, _Q_000_F_001, _Q_000_F_002) 
SELECT
T2._Fld2250_TYPE _Q_000_F_000_TYPE,
T2._Fld2250_RTRef _Q_000_F_000_RTRef,
T2._Fld2250_RRRef _Q_000_F_000_RRRef,
T1._Fld3073 _Q_000_F_001,
@P1 _Q_000_F_002
into ##tt379
FROM dbo._InfoRg3071 T1
LEFT OUTER JOIN dbo._Document125X1 T2
ON (T1._Fld3072RRef = T2._IDRRef) AND (T2._Fld4704 = @P2)
LEFT OUTER JOIN ##tt375 T3 WITH(NOLOCK)
ON (0x08 = T3._Q_000_F_000_TYPE AND 0x00000038 = T3._Q_000_F_000_RTRef AND T2._Fld2251RRef = T3._Q_000_F_000_RRRef)
WHERE ((T1._Fld4704 = @P3)) AND ((T1._Fld3073 >= @P4) AND (T1._Fld3073 <= @P5) AND (T2._Fld2264RRef = @P6) AND T2._Posted = 0x01 
AND (T3._Q_000_F_000_TYPE IS NULL AND T3._Q_000_F_000_RTRef IS NULL AND T3._Q_000_F_000_RRRef IS NULL))',
N'@P1 nvarchar(4000),@P2 numeric(10),@P3 numeric(10),@P4 datetime2(3),@P5 datetime2(3),@P6 varbinary(16)',
N'denso',0,0,@DateStart,@DateEnd,0xBF3C881733694B8F462E8D8B9E26692F


--КупилиРанее
exec sp_executesql N'--INSERT INTO #tt380 WITH(TABLOCK) (_Q_000_F_000_TYPE, _Q_000_F_000_RTRef, _Q_000_F_000_RRRef, _Q_000_F_001, _Q_000_F_002) 
SELECT
T2._Fld2250_TYPE _Q_000_F_000_TYPE,
T2._Fld2250_RTRef _Q_000_F_000_RTRef,
T2._Fld2250_RRRef _Q_000_F_000_RRRef,
T1._Fld3073 _Q_000_F_001,
@P1 _Q_000_F_002
into ##tt380
FROM dbo._InfoRg3071 T1
LEFT OUTER JOIN dbo._Document125X1 T2
ON (T1._Fld3072RRef = T2._IDRRef) AND (T2._Fld4704 = @P2)
LEFT OUTER JOIN ##tt375 T3 WITH(NOLOCK)
ON (0x08 = T3._Q_000_F_000_TYPE AND 0x00000038 = T3._Q_000_F_000_RTRef AND T2._Fld2251RRef = T3._Q_000_F_000_RRRef)
WHERE ((T1._Fld4704 = @P3)) AND ((T1._Fld3073 < @P4) AND ((DATEADD(SECOND,-@P5,T1._Fld3075) > @P6) OR (T1._Fld3075 = @P7)) 
AND (T2._Fld2264RRef = @P8) AND T2._Posted = 0x01 
AND (T3._Q_000_F_000_TYPE IS NULL AND T3._Q_000_F_000_RTRef IS NULL AND T3._Q_000_F_000_RRRef IS NULL))',
N'@P1 nvarchar(4000),@P2 numeric(10),@P3 numeric(10),@P4 datetime2(3),@P5 numeric(10),@P6 datetime2(3),@P7 datetime2(3),@P8 varbinary(16)',
N'denso',0,0,@DateStart,1,@DateEnd,'2001-01-01 00:00:00',0xBF3C881733694B8F462E8D8B9E26692F


--ЗакончилисьПред3Месяца
exec sp_executesql N'--INSERT INTO #tt381 WITH(TABLOCK) (_Q_000_F_000, _Q_000_F_001_TYPE, _Q_000_F_001_RTRef, _Q_000_F_001_RRRef, _Q_000_F_002RRef, _Q_000_F_003) 
SELECT
MAX(DATEADD(SECOND,-1.0,T1._Fld3075)) _Q_000_F_000,
T2._Fld2250_TYPE _Q_000_F_001_TYPE,
T2._Fld2250_RTRef _Q_000_F_001_RTRef,
T2._Fld2250_RRRef _Q_000_F_001_RRRef,
T2._Fld2263RRef _Q_000_F_002RRef,
@P1 _Q_000_F_003
into ##tt381
FROM dbo._InfoRg3071 T1
LEFT OUTER JOIN dbo._Document125X1 T2
ON (T1._Fld3072RRef = T2._IDRRef) AND (T2._Fld4704 = @P2)
LEFT OUTER JOIN ##tt377 T3 WITH(NOLOCK)
ON (T2._Fld2250_TYPE = T3._Q_000_F_001_TYPE AND T2._Fld2250_RTRef = T3._Q_000_F_001_RTRef AND T2._Fld2250_RRRef = T3._Q_000_F_001_RRRef) AND (T2._Fld2263RRef = T3._Q_000_F_002RRef)
LEFT OUTER JOIN ##tt378 T4 WITH(NOLOCK)
ON (T2._Fld2250_TYPE = T4._Q_000_F_001_TYPE AND T2._Fld2250_RTRef = T4._Q_000_F_001_RTRef AND T2._Fld2250_RRRef = T4._Q_000_F_001_RRRef) AND (T2._Fld2263RRef = T4._Q_000_F_002RRef)
LEFT OUTER JOIN ##tt380 T5 WITH(NOLOCK)
ON (T2._Fld2250_TYPE = T5._Q_000_F_000_TYPE AND T2._Fld2250_RTRef = T5._Q_000_F_000_RTRef AND T2._Fld2250_RRRef = T5._Q_000_F_000_RRRef)
LEFT OUTER JOIN ##tt375 T6 WITH(NOLOCK)
ON (0x08 = T6._Q_000_F_000_TYPE AND 0x00000038 = T6._Q_000_F_000_RTRef AND T2._Fld2251RRef = T6._Q_000_F_000_RRRef)
WHERE ((T1._Fld4704 = @P3)) AND ((DATEADD(SECOND,-@P4,T1._Fld3075) >= @P5) AND (DATEADD(SECOND,-@P6,T1._Fld3075) < @P7) AND (T2._Fld2264RRef = @P8) AND T2._Posted = 0x01 AND (T3._Q_000_F_001_TYPE IS NULL AND T3._Q_000_F_001_RTRef IS NULL AND T3._Q_000_F_001_RRRef IS NULL) AND (T4._Q_000_F_001_TYPE IS NULL AND T4._Q_000_F_001_RTRef IS NULL AND T4._Q_000_F_001_RRRef IS NULL) AND (T5._Q_000_F_000_TYPE IS NULL AND T5._Q_000_F_000_RTRef IS NULL AND T5._Q_000_F_000_RRRef IS NULL) AND (T6._Q_000_F_000_TYPE IS NULL AND T6._Q_000_F_000_RTRef IS NULL AND T6._Q_000_F_000_RRRef IS NULL))
GROUP BY T2._Fld2250_TYPE,
T2._Fld2250_RTRef,
T2._Fld2250_RRRef,
T2._Fld2263RRef',N'@P1 nvarchar(4000),@P2 numeric(10),@P3 numeric(10),@P4 numeric(10),@P5 datetime2(3),@P6 numeric(10),@P7 datetime2(3),@P8 varbinary(16)',
N'denso',0,0,1,@DateStart3mon,1,@DateStart10,0xBF3C881733694B8F462E8D8B9E26692F


--ТаблицаПродлений
exec sp_executesql N'--INSERT INTO #tt382 WITH(TABLOCK) (_Q_000_F_000RRef, _Q_000_F_001_TYPE, _Q_000_F_001_RTRef, _Q_000_F_001_RRRef, _Q_000_F_002, 
--_Q_000_F_003, _Q_000_F_004, _Q_000_F_005, _Q_000_F_006, _Q_000_F_007, _Q_000_F_008, _Q_000_F_009) 
SELECT
T1._Q_000_F_002RRef _Q_000_F_000RRef,
T1._Q_000_F_001_TYPE,
T1._Q_000_F_001_RTRef,
T1._Q_000_F_001_RRRef,
T1._Q_000_F_000 _Q_000_F_002,
T3._Q_000_F_001 _Q_000_F_003,
T4._Q_000_F_001 _Q_000_F_004,
CAST(NULL AS DATETIME) _Q_000_F_005,
CAST(NULL AS DATETIME) _Q_000_F_006,
CASE WHEN T1._Q_000_F_003 = 0x01 THEN @P1 ELSE @P2 END _Q_000_F_007,
CASE WHEN T1._Q_000_F_003 = 0x01 AND (T3._Q_000_F_000_TYPE IS NULL AND T3._Q_000_F_000_RTRef IS NULL AND T3._Q_000_F_000_RRRef IS NULL) 
AND (T4._Q_000_F_000_TYPE IS NULL AND T4._Q_000_F_000_RTRef IS NULL AND T4._Q_000_F_000_RRRef IS NULL) THEN @P3 ELSE @P4 END _Q_000_F_008,
@P5 _Q_000_F_009
into ##tt382
FROM ##tt377 T1 WITH(NOLOCK)
LEFT OUTER JOIN ##tt376 T2 WITH(NOLOCK)
ON (T1._Q_000_F_001_TYPE = 0x08 AND T1._Q_000_F_001_RTRef = 0x00000033 AND T1._Q_000_F_001_RRRef = T2._Q_000_F_000RRef)
LEFT OUTER JOIN ##tt379 T3 WITH(NOLOCK)
ON (T1._Q_000_F_001_TYPE = T3._Q_000_F_000_TYPE AND T1._Q_000_F_001_RTRef = T3._Q_000_F_000_RTRef AND T1._Q_000_F_001_RRRef = T3._Q_000_F_000_RRRef)
LEFT OUTER JOIN ##tt380 T4 WITH(NOLOCK)
ON (T1._Q_000_F_001_TYPE = T4._Q_000_F_000_TYPE AND T1._Q_000_F_001_RTRef = T4._Q_000_F_000_RTRef AND T1._Q_000_F_001_RRRef = T4._Q_000_F_000_RRRef)
WHERE CASE WHEN T1._Q_000_F_003 = 0x01 THEN CASE WHEN (T2._Q_000_F_000RRef IS NULL) THEN 0x01 ELSE 0x00 END ELSE 0x01 END = 0x01
UNION ALL SELECT
T5._Q_000_F_002RRef,
T5._Q_000_F_001_TYPE,
T5._Q_000_F_001_RTRef,
T5._Q_000_F_001_RRRef,
CAST(NULL AS DATETIME),
CAST(NULL AS DATETIME),
CAST(NULL AS DATETIME),
T6._Q_000_F_001,
CAST(NULL AS DATETIME),
CAST(NULL AS NUMERIC(1, 0)),
CAST(NULL AS NUMERIC(1, 0)),
@P6
FROM ##tt378 T5 WITH(NOLOCK)
INNER JOIN ##tt379 T6 WITH(NOLOCK)
ON (T5._Q_000_F_001_TYPE = T6._Q_000_F_000_TYPE AND T5._Q_000_F_001_RTRef = T6._Q_000_F_000_RTRef AND T5._Q_000_F_001_RRRef = T6._Q_000_F_000_RRRef) AND (CAST(DATEDIFF(DAY,T5._Q_000_F_000,T6._Q_000_F_001) AS NUMERIC(12)) <= @P7)
UNION ALL SELECT
T7._Q_000_F_002RRef,
T7._Q_000_F_001_TYPE,
T7._Q_000_F_001_RTRef,
T7._Q_000_F_001_RRRef,
CAST(NULL AS DATETIME),
CAST(NULL AS DATETIME),
CAST(NULL AS DATETIME),
CAST(NULL AS DATETIME),
T8._Q_000_F_001,
CAST(NULL AS NUMERIC(1, 0)),
CAST(NULL AS NUMERIC(1, 0)),
@P8
FROM ##tt381 T7 WITH(NOLOCK)
INNER JOIN ##tt379 T8 WITH(NOLOCK)
ON (T7._Q_000_F_001_TYPE = T8._Q_000_F_000_TYPE AND T7._Q_000_F_001_RTRef = T8._Q_000_F_000_RTRef AND T7._Q_000_F_001_RRRef = T8._Q_000_F_000_RRRef)
UNION ALL SELECT
T9._Q_000_F_002RRef,
T9._Q_000_F_001_TYPE,
T9._Q_000_F_001_RTRef,
T9._Q_000_F_001_RRRef,
CAST(NULL AS DATETIME),
CAST(NULL AS DATETIME),
CAST(NULL AS DATETIME),
CAST(NULL AS DATETIME),
T10._Q_000_F_001,
CAST(NULL AS NUMERIC(1, 0)),
CAST(NULL AS NUMERIC(1, 0)),
@P9
FROM ##tt378 T9 WITH(NOLOCK)
INNER JOIN ##tt379 T10 WITH(NOLOCK)
ON (T9._Q_000_F_001_TYPE = T10._Q_000_F_000_TYPE AND T9._Q_000_F_001_RTRef = T10._Q_000_F_000_RTRef AND T9._Q_000_F_001_RRRef = T10._Q_000_F_000_RRRef) 
AND (CAST(DATEDIFF(DAY,T9._Q_000_F_000,T10._Q_000_F_001) AS NUMERIC(12)) > @P10)',
N'@P1 numeric(10),@P2 numeric(10),@P3 numeric(10),@P4 numeric(10),@P5 nvarchar(4000),@P6 nvarchar(4000),@P7 numeric(10),@P8 nvarchar(4000),
@P9 nvarchar(4000),@P10 numeric(10)',1,0,1,0,N'denso',N'denso',10,N'denso',N'denso',10



exec sp_executesql N'SELECT
@P1 [Date],
T1._Q_000_F_000RRef [ClubID],
(T2._Fld663RRef) [ManagerID],
CAST(COUNT_BIG(T1._Q_000_F_002) AS NUMERIC(12)) [Expired],
(((CAST(COUNT_BIG(T1._Q_000_F_004) AS NUMERIC(12)) + CAST(COUNT_BIG(T1._Q_000_F_003) AS NUMERIC(12))) + CAST(COUNT_BIG(T1._Q_000_F_005) AS NUMERIC(12))) 
    + CAST(COUNT_BIG(T1._Q_000_F_006) AS NUMERIC(12))) [Continued]
into ##PercentsTable
FROM ##tt382 T1 WITH(NOLOCK)
LEFT OUTER JOIN dbo._Reference51X1 T2
ON (T1._Q_000_F_001_TYPE = 0x08 AND T1._Q_000_F_001_RTRef = 0x00000033 AND T1._Q_000_F_001_RRRef = T2._IDRRef) AND (T2._Fld4704 = @P3)
GROUP BY T1._Q_000_F_000RRef,
(T2._Fld663RRef)',N'@P1 datetime2(3),@P2 nvarchar(4000),@P3 numeric(10)',@DateStart,N'denso',0



delete	
from	dwh.[dbo].[PercentFacts]
where	[Date] between dateadd(year,-2000,@DateStart) and dateadd(year,-2000,@DateEnd)



INSERT INTO dwh.[dbo].[PercentFacts]
           ([Date]
           ,[ClubID]
           ,[ManagerID]
           ,[Expired]
           ,[Continued])
select  dateadd(year,-2000,[Date]),
        sys.fn_varbintohexstr(t.ClubID),
        sys.fn_varbintohexstr(t.ManagerID),
        t.Expired,
        t.Continued
from    ##PercentsTable t






drop table ##tt375
drop table ##tt376
drop table ##tt377
drop table ##tt378
drop table ##tt379
drop table ##tt380
drop table ##tt381
drop table ##tt382
drop table ##PercentsTable